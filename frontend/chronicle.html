<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Phylos Chronicle</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=UnifrakturMaguntia&family=Inter:wght@400;500;600;700&family=EB+Garamond:wght@400;500&display=swap" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
      .summary-box {
        padding: 12px;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.04);
        min-height: 120px;
        white-space: pre-wrap;
      }
      .chat-messages {
        max-height: 240px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 10px;
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid rgba(255, 255, 255, 0.05);
        border-radius: 12px;
        padding: 12px;
      }
      .chat-entry {
        display: flex;
        gap: 10px;
        align-items: flex-start;
      }
      .chat-entry.user {
        flex-direction: row-reverse;
        text-align: right;
      }
      .chat-entry .avatar {
        width: 38px;
        height: 38px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.08);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 0.85rem;
      }
      .chat-entry.user .avatar {
        background: linear-gradient(135deg, #6dffd6, #2ba6ff);
        color: #062335;
      }
      .chat-entry.assistant .avatar {
        background: rgba(146, 112, 255, 0.35);
        color: #ffffff;
      }
      .chat-entry.system .avatar {
        background: rgba(255, 193, 59, 0.3);
        color: #2d1a00;
      }
      .chat-entry .bubble {
        border-radius: 16px;
        padding: 10px 14px;
        border: 1px solid rgba(255, 255, 255, 0.08);
        background: rgba(255, 255, 255, 0.03);
        max-width: 75%;
      }
      .chat-entry.user .bubble {
        background: linear-gradient(135deg, rgba(109, 255, 214, 0.25), rgba(43, 166, 255, 0.2));
        border-color: rgba(109, 255, 214, 0.4);
      }
      .chat-entry.assistant .bubble {
        background: rgba(146, 112, 255, 0.18);
        border-color: rgba(146, 112, 255, 0.4);
      }
      .chat-entry.system .bubble {
        background: rgba(255, 193, 59, 0.15);
        border-color: rgba(255, 193, 59, 0.4);
      }
    </style>
  </head>
  <body class="min-h-screen bg-gradient-to-b from-slate-900 via-blue-950 to-indigo-950 text-gray-100">
    <div id="root"></div>

    <script>
      (function () {
        try {
      const { useState, useEffect, useRef } = React;

      function createHtmlRenderer(createElement) {
        const PLACE_PREFIX = "__HTMEXP__";
        const PLACE_SUFFIX = "__";
        const PLACE_PREFIX_LEN = PLACE_PREFIX.length;
        const PLACE_SUFFIX_LEN = PLACE_SUFFIX.length;

        function isWhitespace(str) {
          return !str || /^[\s\r\n\t]+$/.test(str);
        }

        function matchPlaceholder(source, index, values) {
          if (source.slice(index, index + PLACE_PREFIX_LEN) !== PLACE_PREFIX) {
            return null;
          }
          let cursor = index + PLACE_PREFIX_LEN;
          let digits = "";
          const limit = source.length;
          while (cursor < limit) {
            const maybeSuffix = source.slice(cursor, cursor + PLACE_SUFFIX_LEN);
            if (maybeSuffix === PLACE_SUFFIX) {
              if (!digits) {
                return null;
              }
              const valueIndex = Number(digits);
              if (!Number.isFinite(valueIndex) || valueIndex >= values.length) {
                return null;
              }
              return {
                value: values[valueIndex],
                length: cursor + PLACE_SUFFIX_LEN - index,
              };
            }
            const ch = source[cursor];
            if (ch >= "0" && ch <= "9") {
              digits += ch;
              cursor += 1;
            } else {
              return null;
            }
          }
          return null;
        }

        const REACT_ELEMENT_TYPE = typeof Symbol === "function" && Symbol.for ? Symbol.for("react.element") : null;

        function isReactElement(value) {
          return value && typeof value === "object" && value.$$typeof === REACT_ELEMENT_TYPE;
        }

        function appendChild(list, child) {
          if (child === null || child === undefined || child === false) {
            return;
          }
          if (Array.isArray(child)) {
            child.forEach((entry) => appendChild(list, entry));
            return;
          }
          if (typeof child === "object" && !isReactElement(child)) {
            throw new Error("Unsupported template child: " + JSON.stringify(child));
          }
          list.push(child);
        }

        function appendText(list, text, values) {
          if (!text) {
            return;
          }
          let buffer = "";
          let cursor = 0;
          while (cursor < text.length) {
            const match = matchPlaceholder(text, cursor, values);
            if (match) {
              if (!isWhitespace(buffer)) {
                let normalized = buffer;
                if (normalized.indexOf("\n") >= 0 || normalized.indexOf("\r") >= 0) {
                  normalized = normalized.trim();
                }
                if (normalized) {
                  appendChild(list, normalized);
                }
              }
              buffer = "";
              appendChild(list, match.value);
              cursor += match.length;
            } else {
              buffer += text[cursor];
              cursor += 1;
            }
          }
          if (!isWhitespace(buffer)) {
            let normalized = buffer;
            if (normalized.indexOf("\n") >= 0 || normalized.indexOf("\r") >= 0) {
              normalized = normalized.trim();
            }
            if (normalized) {
              appendChild(list, normalized);
            }
          }
        }

        function skipWhitespace(str, index) {
          let cursor = index;
          while (cursor < str.length && /\s/.test(str[cursor])) {
            cursor += 1;
          }
          return cursor;
        }

        function readTagName(str, index, values) {
          let cursor = skipWhitespace(str, index);
          if (cursor >= str.length) {
            return { name: "div", next: cursor };
          }
          const dynamic = matchPlaceholder(str, cursor, values);
          if (dynamic) {
            return { name: dynamic.value, next: cursor + dynamic.length };
          }
          let start = cursor;
          while (cursor < str.length && /[A-Za-z0-9:_-]/.test(str[cursor])) {
            cursor += 1;
          }
          const name = str.slice(start, cursor) || "div";
          return { name, next: cursor };
        }

        function readAttribute(str, index, values) {
          let cursor = index;
          cursor = skipWhitespace(str, cursor);
          const start = cursor;
          while (cursor < str.length && !/[\s=/>]/.test(str[cursor])) {
            cursor += 1;
          }
          const name = str.slice(start, cursor);
          cursor = skipWhitespace(str, cursor);
          let value = true;
          if (str[cursor] === "=") {
            cursor += 1;
            cursor = skipWhitespace(str, cursor);
            if (str[cursor] === '"') {
              cursor += 1;
              let literal = "";
              while (cursor < str.length && str[cursor] !== '"') {
                const match = matchPlaceholder(str, cursor, values);
                if (match) {
                  literal += match.value !== undefined ? String(match.value) : "";
                  cursor += match.length;
                } else {
                  literal += str[cursor];
                  cursor += 1;
                }
              }
              cursor += 1;
              value = literal;
            } else {
              const match = matchPlaceholder(str, cursor, values);
              if (match) {
                value = match.value;
                cursor += match.length;
              } else {
                const startValue = cursor;
                while (cursor < str.length && !/[\s/>]/.test(str[cursor])) {
                  cursor += 1;
                }
                value = str.slice(startValue, cursor);
              }
            }
          }
          return { name, value, next: cursor };
        }

        function readAttributes(str, index, node, values) {
          let cursor = index;
          let selfClosing = false;
          while (cursor < str.length) {
            cursor = skipWhitespace(str, cursor);
            if (cursor >= str.length) {
              break;
            }
            const current = str[cursor];
            if (current === ">") {
              cursor += 1;
              break;
            }
            if (current === "/" && str[cursor + 1] === ">") {
              cursor += 2;
              selfClosing = true;
              break;
            }
            const attribute = readAttribute(str, cursor, values);
            cursor = attribute.next;
            if (attribute.name) {
              node.props[attribute.name] = attribute.value;
            }
          }
          return { next: cursor, selfClosing };
        }

        function createElementFromNode(node) {
          if (!node) {
            return null;
          }
          const tag = node.type;
          const isValidTag =
            typeof tag === "string" ||
            typeof tag === "function" ||
            (typeof tag === "symbol");
          if (!isValidTag) {
            console.error("Invalid element type detected in template:", tag);
            throw new Error("Unsupported element type in template");
          }
          const args = [tag, node.props];
          if (node.children.length) {
            node.children.forEach((child) => args.push(child));
          }
          return createElement.apply(null, args);
        }

        function parseMarkup(source, values) {
          const root = { children: [] };
          const stack = [root];
          let cursor = 0;
          while (cursor < source.length) {
            const current = source[cursor];
            if (current === "<") {
              if (source[cursor + 1] === "/") {
                cursor += 2;
                while (cursor < source.length && source[cursor] !== ">") {
                  const skip = matchPlaceholder(source, cursor, values);
                  if (skip) {
                    cursor += skip.length;
                  } else {
                    cursor += 1;
                  }
                }
                cursor += 1;
                const node = stack.pop();
                if (!node) {
                  throw new Error("Malformed template markup");
                }
                const parent = stack[stack.length - 1];
                appendChild(parent.children, createElementFromNode(node));
              } else {
                cursor += 1;
                const { name, next } = readTagName(source, cursor, values);
                cursor = next;
                const node = { type: name, props: {}, children: [] };
                const attrState = readAttributes(source, cursor, node, values);
                cursor = attrState.next;
                if (attrState.selfClosing) {
                  const parent = stack[stack.length - 1];
                  appendChild(parent.children, createElementFromNode(node));
                } else {
                  stack.push(node);
                }
              }
            } else {
              const start = cursor;
              while (cursor < source.length && source[cursor] !== "<") {
                cursor += 1;
              }
              const textSegment = source.slice(start, cursor);
              appendText(stack[stack.length - 1].children, textSegment, values);
            }
          }
          if (stack.length !== 1) {
            throw new Error("Unbalanced template detected");
          }
          return root.children;
        }

        return function html(strings, ...values) {
          let markup = "";
          for (let index = 0; index < strings.length; index += 1) {
            markup += strings[index];
            if (index < values.length) {
              markup += PLACE_PREFIX + index + PLACE_SUFFIX;
            }
          }
          const children = parseMarkup(markup, values);
          if (children.length === 1) {
            return children[0];
          }
          return createElement.apply(null, [React.Fragment, null].concat(children));
        };
      }

      const html = createHtmlRenderer(React.createElement);

      const LucideIcon = ({ name, className }) => {
        const icon = window.lucide && window.lucide.icons && window.lucide.icons[name];
        if (!icon) return null;

        const normalizeChildren = (children) => {
          if (!children) {
            return [];
          }
          return Array.isArray(children) ? children : [children];
        };

        const renderNode = (node, key) => {
          if (!node) return null;
          const tuple = Array.isArray(node) ? node : [node];
          const tag = tuple[0];
          const attrs = tuple[1] || {};
          const childNodes = normalizeChildren(tuple[2]);
          return React.createElement(
            tag,
            { ...attrs, key, stroke: 'currentColor', fill: 'none' },
            childNodes.map((child, index) => renderNode(child, `${key}-${index}`))
          );
        };

        const tag = icon[0];
        const attrs = icon[1] || {};
        const children = normalizeChildren(icon[2]);
        return React.createElement(
          tag,
          { ...attrs, className, stroke: 'currentColor', fill: 'none' },
          children.map((child, index) => renderNode(child, index))
        );
      };

      const formatTimestamp = (timestamp) => {
        if (!timestamp) return 'Unknown';
        try {
          return new Date(timestamp).toLocaleString();
        } catch (err) {
          return timestamp;
        }
      };

      const readAttr = (container, key) => {
        if (!container || typeof container !== 'object') {
          return undefined;
        }
        return container[key];
      };

      const readScore = (value) => {
        const num = typeof value === 'number' ? value : parseFloat(value);
        return Number.isFinite(num) ? num : 0;
      };

      const buildMutationEvents = (edges = [], nodes = []) => {
        const nodeMap = nodes.reduce((acc, node) => {
          acc[node.id] = node;
          return acc;
        }, {});
        return edges
          .filter((edge) => {
            const attrs = readAttr(edge, 'attributes');
            return attrs && attrs.relation_type === 'Mutation';
          })
          .sort((a, b) => {
            const aScore = readScore(readAttr(readAttr(a, 'attributes'), 'mutation_score'));
            const bScore = readScore(readAttr(readAttr(b, 'attributes'), 'mutation_score'));
            return bScore - aScore;
          })
          .slice(0, 5)
          .map((edge) => ({
            node: edge.target,
            score: readScore(readAttr(readAttr(edge, 'attributes'), 'mutation_score')),
            type: 'mutation',
            timestamp: (nodeMap[edge.target] && nodeMap[edge.target].timestamp) || 'N/A',
            title: nodeMap[edge.target] && nodeMap[edge.target].content
              ? nodeMap[edge.target].content.slice(0, 80)
              : edge.target,
          }));
      };

      const enrichNodes = (graph) => {
        const edges = graph.edges || [];
        const scoreMap = edges.reduce((acc, edge) => {
          if (edge.target) {
            const attrs = readAttr(edge, 'attributes');
            acc[edge.target] = readScore(attrs && attrs.mutation_score);
          }
          return acc;
        }, {});
        return (graph.nodes || []).map((node) => ({
          id: node.id,
          title: node.content && node.content.split('. ')[0] ? node.content.split('. ')[0] : node.id,
          url: node.id,
          mutationScore: scoreMap[node.id] || 0,
          timestamp: node.timestamp,
          author: node.author || 'Unknown',
          depth: node.depth || 0,
          content: node.content || '',
        }));
      };

      function PhylosUI() {
        const [url, setUrl] = useState('');
        const [maxDepth, setMaxDepth] = useState(3);
        const [isAnalyzing, setIsAnalyzing] = useState(false);
        const [graphData, setGraphData] = useState(null);
        const [selectedNode, setSelectedNode] = useState(null);
        const [mutationEvents, setMutationEvents] = useState([]);
        const [telemetry, setTelemetry] = useState({ events: 0, nodes: 0, mutations: 0, replications: 0 });
        const [summary, setSummary] = useState('Submit a URL to begin a trace.');
        const [sessionId, setSessionId] = useState(null);
        const [chatMessages, setChatMessages] = useState([
          { role: 'system', text: 'Submit a source URL and select "Trace Origin" to begin.' },
        ]);
        const [chatInput, setChatInput] = useState('');
        const wsRef = useRef(null);

        useEffect(() => {
          return () => {
            if (wsRef.current) {
              wsRef.current.close();
            }
          };
        }, []);

        const appendMessage = (role, text) => {
          setChatMessages((prev) => [...prev, { role, text }]);
        };

        const fetchGraphSnapshot = async (id) => {
          try {
            const response = await fetch(`/session/${id}/graph`);
            if (!response.ok) {
              throw new Error('Failed to load graph snapshot');
            }
            const payload = await response.json();
            const enrichedNodes = enrichNodes(payload);
            setGraphData({ nodes: enrichedNodes, edges: payload.edges || [] });
            if (enrichedNodes.length) {
              setSelectedNode(enrichedNodes[0]);
            }
            setMutationEvents(buildMutationEvents(payload.edges, enrichedNodes));
            const stats = payload.stats || {};
            setTelemetry((prev) => ({
              ...prev,
              nodes: typeof stats.nodes === 'number' ? stats.nodes : prev.nodes,
              mutations: typeof stats.mutations === 'number' ? stats.mutations : prev.mutations,
              replications: typeof stats.replications === 'number' ? stats.replications : prev.replications,
            }));
          } catch (error) {
            console.error(error);
            appendMessage('system', 'Unable to load final graph snapshot.');
          }
        };

        const handleSocketMessage = (message) => {
          if (message.status) {
            if (message.status === 'session') {
              setSessionId(message.session_id);
              appendMessage('system', `Session established (${message.session_id.slice(0, 8)}…).`);
              return;
            }
            if (message.status === 'summary') {
              setSummary(message.summary || 'Summary unavailable.');
              appendMessage('assistant', 'Trace complete. Ask me what you would like to investigate.');
              setIsAnalyzing(false);
              if (message.session_id) {
                fetchGraphSnapshot(message.session_id);
              } else if (sessionId) {
                fetchGraphSnapshot(sessionId);
              }
              return;
            }
            if (message.status === 'info') {
              appendMessage('system', message.message || 'Info update received.');
              return;
            }
            if (message.status === 'error') {
              appendMessage('system', message.message || 'An error occurred.');
              setIsAnalyzing(false);
              return;
            }
          }

          if (message.event) {
            const data = message.data || {};
            const knowledgeGraph = data.knowledge_graph || {};
            const edgeStats = data.edge_stats || {};
            setTelemetry((prev) => {
              const nodeCount = typeof knowledgeGraph.node_count === 'number' ? knowledgeGraph.node_count : prev.nodes;
              const mutationIncrement = typeof edgeStats.mutation_count === 'number' ? edgeStats.mutation_count : 0;
              const replicationIncrement = typeof edgeStats.replication_count === 'number' ? edgeStats.replication_count : 0;
              return {
                events: prev.events + 1,
                nodes: Math.max(prev.nodes, nodeCount),
                mutations: prev.mutations + mutationIncrement,
                replications: prev.replications + replicationIncrement,
              };
            });
          }
        };

        const startAnalysis = () => {
          if (!url || isAnalyzing) return;
          setIsAnalyzing(true);
          setGraphData(null);
          setSelectedNode(null);
          setMutationEvents([]);
          setTelemetry({ events: 0, nodes: 0, mutations: 0, replications: 0 });
          setSummary('Tracing narrative lineage...');
          setChatMessages([{ role: 'system', text: 'Investigation running… chat will unlock once complete.' }]);
          if (wsRef.current) {
            wsRef.current.close();
          }
          const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
          const wsUrl = `${protocol}://${window.location.host}/ws/dna-stream`;
          const ws = new WebSocket(wsUrl);
          wsRef.current = ws;

          ws.onopen = () => {
            ws.send(JSON.stringify({ start_url: url, max_depth: Number(maxDepth) || 1 }));
          };
          ws.onmessage = (event) => {
            try {
              const payload = JSON.parse(event.data);
              handleSocketMessage(payload);
            } catch (error) {
              console.error('Failed to parse WebSocket message', error);
            }
          };
          ws.onerror = () => {
            appendMessage('system', 'WebSocket error encountered.');
            setIsAnalyzing(false);
          };
          ws.onclose = () => {
            setIsAnalyzing(false);
          };
        };

        const sendChatMessage = async (evt) => {
          evt.preventDefault();
          if (!chatInput.trim() || !sessionId) {
            return;
          }
          const message = chatInput.trim();
          setChatInput('');
          appendMessage('user', message);
          try {
            const response = await fetch('/chat', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ session_id: sessionId, message }),
            });
            const payload = await response.json();
            if (!response.ok) {
              appendMessage('system', payload.detail || 'Chat failed.');
              return;
            }
            appendMessage('assistant', payload.reply || 'I need more context.');
          } catch (error) {
            appendMessage('system', 'Unable to reach chat endpoint.');
          }
        };

        const getMutationColor = (score) => {
          if (score < 0.2) return 'bg-emerald-800';
          if (score < 0.5) return 'bg-amber-700';
          return 'bg-red-900';
        };

        const getMutationLabel = (score) => {
          if (score < 0.2) return 'Authentic';
          if (score < 0.5) return 'Modified';
          return 'Corrupted';
        };

        const averageMutation = graphData && Array.isArray(graphData.nodes) && graphData.nodes.length
          ? graphData.nodes.reduce((acc, node) => acc + (node.mutationScore || 0), 0) / graphData.nodes.length
          : 0;

        const renderTraceButton = () => {
          if (isAnalyzing) {
            return html`
              <div className="flex items-center gap-2">
                <div className="w-5 h-5 border-2 border-amber-200/30 border-t-amber-200 rounded-full animate-spin"></div>
                <span>Investigating</span>
              </div>
            `;
          }
          return html`
            <div className="flex items-center gap-2">
              <${LucideIcon} name="Zap" className="w-5 h-5" />
              <span>Trace Origin</span>
            </div>
          `;
        };

        const renderGraphGrid = () => {
          if (!graphData) {
            return null;
          }
          return html`
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
              <div className="lg:col-span-2 bg-gradient-to-br from-slate-900/50 to-slate-800/40 rounded-sm p-6 border-2 border-amber-900/30 backdrop-blur-md shadow-2xl">
                <div className="border-b-2 border-amber-900/30 pb-4 mb-6">
                  <div className="flex items-center justify-between">
                    <div className="flex items-center gap-3">
                      <${LucideIcon} name="Link2" className="w-5 h-5 text-amber-700" />
                      <h3 className="text-xl font-serif text-amber-100/90">Citation Network</h3>
                    </div>
                    <div className="flex gap-3 text-xs font-serif">
                      <div className="flex items-center gap-1.5">
                        <div className="w-3 h-3 bg-emerald-800 border border-emerald-600"></div>
                        <span className="text-emerald-300">Authentic</span>
                      </div>
                      <div className="flex items-center gap-1.5">
                        <div className="w-3 h-3 bg-amber-700 border border-amber-500"></div>
                        <span className="text-amber-300">Modified</span>
                      </div>
                      <div className="flex items-center gap-1.5">
                        <div className="w-3 h-3 bg-red-900 border border-red-700"></div>
                        <span className="text-red-300">Corrupted</span>
                      </div>
                    </div>
                  </div>
                </div>

                <div className="space-y-4">
                  ${graphData.nodes.map((node) => {
                    const isActive = selectedNode && selectedNode.id === node.id;
                    const badgeClass = node.mutationScore < 0.2
                      ? 'bg-emerald-900/40 border-emerald-700 text-emerald-200'
                      : node.mutationScore < 0.5
                      ? 'bg-amber-900/40 border-amber-700 text-amber-200'
                      : 'bg-red-900/40 border-red-700 text-red-200';
                    const borderClass = node.mutationScore < 0.2
                      ? 'border-emerald-600'
                      : node.mutationScore < 0.5
                      ? 'border-amber-500'
                      : 'border-red-700';
                    return html`
                      <div
                        key=${node.id}
                        onClick=${() => setSelectedNode(node)}
                        className=${`p-5 border-2 cursor-pointer transition-all ${
                          isActive
                            ? 'bg-amber-900/20 border-amber-700/60 shadow-lg'
                            : 'bg-black/30 border-amber-900/30 hover:border-amber-800/50 hover:bg-amber-950/20'
                        }`}
                      >
                        <div className="flex items-start gap-4">
                          <div className=${`w-14 h-14 ${getMutationColor(node.mutationScore)} border-2 ${borderClass} flex items-center justify-center flex-shrink-0 shadow-lg`}>
                            ${node.mutationScore < 0.2
                              ? html`<${LucideIcon} name="Shield" className="w-7 h-7 text-emerald-100" />`
                              : node.mutationScore < 0.5
                              ? html`<${LucideIcon} name="TrendingUp" className="w-7 h-7 text-amber-100" />`
                              : html`<${LucideIcon} name="AlertTriangle" className="w-7 h-7 text-red-100" />`}
                          </div>
                          <div className="flex-1 min-w-0">
                            <div className="flex items-start justify-between mb-2">
                              <div className="flex-1">
                                <h4 className="font-serif text-lg font-bold text-amber-50 mb-1">${node.title}</h4>
                                <p className="text-xs text-amber-700/70 uppercase tracking-wide font-serif">By ${node.author}</p>
                              </div>
                              <span className=${`text-xs px-3 py-1 border-2 ml-4 ${badgeClass} font-serif uppercase tracking-wider`}>
                                ${getMutationLabel(node.mutationScore)}
                              </span>
                            </div>
                            <p className="text-sm text-amber-300/50 font-mono truncate border-l-2 border-amber-900/30 pl-3">${node.url}</p>
                            <div className="flex items-center gap-4 mt-3 text-xs text-amber-600/60 font-serif italic border-t border-amber-900/20 pt-2">
                              <span>Mutation Index: ${node.mutationScore.toFixed(3)}</span>
                              <span>•</span>
                              <span>Published: ${formatTimestamp(node.timestamp)}</span>
                            </div>
                          </div>
                          <${LucideIcon} name="ChevronRight" className="w-5 h-5 text-amber-700/40" />
                        </div>
                      </div>
                    `;
                  })}
                </div>
              </div>

              <div className="space-y-6">
                <div className="bg-gradient-to-br from-slate-900/50 to-slate-800/40 rounded-sm p-6 border-2 border-amber-900/30 backdrop-blur-md shadow-2xl">
                  <h3 className="text-lg font-serif text-amber-100/90 mb-4 pb-2 border-b-2 border-amber-900/30 flex items-center gap-2">
                    <${LucideIcon} name="Activity" className="w-5 h-5 text-amber-700" />
                    Investigation Report
                  </h3>
                  <div className="space-y-4 font-serif">
                    <div className="flex justify-between items-center border-b border-amber-900/20 pb-2">
                      <span className="text-amber-300/70 text-sm">Events Streamed</span>
                      <span className="font-bold text-2xl text-amber-100">${telemetry.events}</span>
                    </div>
                    <div className="flex justify-between items-center border-b border-amber-900/20 pb-2">
                      <span className="text-amber-300/70 text-sm">Sources Traced</span>
                      <span className="font-bold text-2xl text-amber-100">${graphData.nodes.length}</span>
                    </div>
                    <div className="flex justify-between items-center border-b border-amber-900/20 pb-2">
                      <span className="text-amber-300/70 text-sm">Corruptions Found</span>
                      <span className="font-bold text-2xl text-red-300">${telemetry.mutations}</span>
                    </div>
                    <div className="flex justify-between items-center border-b border-amber-900/20 pb-2">
                      <span className="text-amber-300/70 text-sm">Replications Logged</span>
                      <span className="font-bold text-2xl text-amber-100">${telemetry.replications}</span>
                    </div>
                    <div className="flex justify-between items-center">
                      <span className="text-amber-300/70 text-sm">Avg. Mutation</span>
                      <span className="font-bold text-2xl text-amber-100">${averageMutation.toFixed(3)}</span>
                    </div>
                  </div>
                </div>

                <div className="bg-gradient-to-br from-red-950/40 to-slate-900/50 rounded-sm p-6 border-2 border-red-900/40 backdrop-blur-md shadow-2xl">
                  <h3 className="text-lg font-serif text-red-200 mb-4 pb-2 border-b-2 border-red-900/30 flex items-center gap-2">
                    <${LucideIcon} name="AlertTriangle" className="w-5 h-5 text-red-400" />
                    Corruption Alerts
                  </h3>
                  <div className="space-y-3">
                    ${mutationEvents.length
                      ? mutationEvents.map((event, idx) => html`
                          <div key=${idx} className="p-4 bg-black/40 border-2 border-red-900/30">
                            <div className="flex items-center justify-between mb-2 pb-2 border-b border-red-900/20">
                              <span className="text-xs font-serif text-red-300 uppercase tracking-wider">
                                ${(event.type || '').replace('_', ' ')}
                              </span>
                              <span className="text-sm text-red-200 font-bold font-mono">
                                ${event.score.toFixed(3)}
                              </span>
                            </div>
                            <p className="text-xs text-amber-400/60 font-serif italic">${formatTimestamp(event.timestamp)}</p>
                            <p className="text-sm text-amber-200/70 font-serif">${event.title || 'Mutation detail unavailable.'}</p>
                          </div>
                        `)
                      : html`<p className="text-sm text-red-300/50 font-serif italic text-center py-4">
                          No major corruptions detected
                        </p>`}
                  </div>
                </div>

                ${selectedNode
                  ? html`
                      <div className="bg-gradient-to-br from-slate-900/50 to-slate-800/40 rounded-sm p-6 border-2 border-amber-900/30 backdrop-blur-md shadow-2xl">
                        <h3 className="text-lg font-serif text-amber-100/90 mb-4 pb-2 border-b-2 border-amber-900/30">
                          Article Details
                        </h3>
                        <div className="space-y-4 text-sm font-serif">
                          <div>
                            <span className="text-amber-600/80 block mb-1 uppercase text-xs tracking-wide">Headline</span>
                            <span className="font-medium text-amber-100">${selectedNode.title}</span>
                          </div>
                          <div>
                            <span className="text-amber-600/80 block mb-1 uppercase text-xs tracking-wide">Source URL</span>
                            <span className="font-mono text-xs text-amber-300/80 break-all">${selectedNode.url}</span>
                          </div>
                          <div>
                            <span className="text-amber-600/80 block mb-1 uppercase text-xs tracking-wide">Author</span>
                            <span className="text-amber-200/90">${selectedNode.author}</span>
                          </div>
                          <div>
                            <span className="text-amber-600/80 block mb-2 uppercase text-xs tracking-wide">Mutation Index</span>
                            <div className="flex items-center gap-3">
                              <div className="flex-1 h-3 bg-black/40 border border-amber-900/30 overflow-hidden">
                                <div
                                  className=${`h-full ${getMutationColor(selectedNode.mutationScore)} border-r-2`}
                                  style=${{ width: `${Math.min(Math.max(selectedNode.mutationScore || 0, 0), 1) * 100}%` }}
                                ></div>
                              </div>
                              <span className="font-bold font-mono text-amber-100">${selectedNode.mutationScore.toFixed(3)}</span>
                            </div>
                          </div>
                        </div>
                      </div>
                    `
                  : null}
              </div>
            </div>
          `;
        };

        const renderEmptyState = () => {
          if (graphData || isAnalyzing) {
            return null;
          }
          return html`
            <div className="text-center py-20">
              <div className="w-32 h-32 bg-amber-950/20 border-4 border-double border-amber-900/40 flex items-center justify-center mx-auto mb-6">
                <${LucideIcon} name="Newspaper" className="w-16 h-16 text-amber-700/40" />
              </div>
              <h3 className="text-2xl font-serif text-amber-200/70 mb-3">Awaiting Investigation</h3>
              <p className="text-amber-400/50 text-sm font-serif italic max-w-md mx-auto">
                Submit a source article above to begin tracing its narrative evolution through the shadows of the information age.
              </p>
              <div className="mt-6 flex items-center justify-center gap-2">
                <div className="h-px w-20 bg-gradient-to-r from-transparent to-amber-800/30"></div>
                <span className="text-xs text-amber-700/50 font-serif">◆</span>
                <div className="h-px w-20 bg-gradient-to-l from-transparent to-amber-800/30"></div>
              </div>
            </div>
          `;
        };

        return html`
          <div className="relative">
            <div
              className="fixed inset-0 opacity-10 pointer-events-none"
              style=${{
                backgroundImage:
                  "url('data:image/svg+xml,%3Csvg width=\\'100\\' height=\\'100\\' xmlns=\\'http://www.w3.org/2000/svg\\'%3E%3Cfilter id=\\'noise\\'%3E%3CfeTurbulence type=\\'fractalNoise\\' baseFrequency=\\'0.9\\' numOctaves=\\'4\\' /%3E%3C/filter%3E%3Crect width=\\'100\\' height=\\'100\\' filter=\\'url(%23noise)\\' opacity=\\'0.4\\'/%3E%3C/svg%3E')",
              }}
            ></div>

            <div className="border-b-4 border-amber-800/30 bg-black/20 backdrop-blur-md relative overflow-hidden">
              <div className="absolute inset-0 bg-gradient-to-r from-transparent via-amber-900/5 to-transparent"></div>
              <div className="max-w-7xl mx-auto px-6 py-6 relative">
                <div className="text-center border-b border-amber-800/20 pb-4 mb-4">
                  <div className="flex items-center justify-center gap-3 mb-2">
                    <div className="h-px w-20 bg-gradient-to-r from-transparent to-amber-700/50"></div>
                    <${LucideIcon} name="Newspaper" className="w-5 h-5 text-amber-700/70" />
                    <div className="h-px w-20 bg-gradient-to-l from-transparent to-amber-700/50"></div>
                  </div>
                  <h1
                    className="text-6xl mb-2 text-amber-100/90 tracking-wide"
                    style=${{
                      fontFamily: '"UnifrakturMaguntia", "Old English Text MT", "Blackletter", serif',
                      textShadow: '2px 2px 4px rgba(0,0,0,0.7)',
                      fontWeight: 400,
                    }}
                  >
                    Phylos Chronicle
                  </h1>
                  <div className="flex items-center justify-center gap-2 text-xs text-amber-700/70 uppercase tracking-widest">
                    <div className="h-px w-12 bg-amber-800/30"></div>
                    <span>Narrative Evolution Ledger</span>
                    <div className="h-px w-12 bg-amber-800/30"></div>
                  </div>
                </div>
                <p className="text-center text-sm text-amber-200/60 italic font-serif">
                  "Tracing the lineage of truth through the shadows of disinformation"
                </p>
              </div>
            </div>

            <div className="max-w-7xl mx-auto px-6 py-8 relative">
              <div className="mb-8">
                <div className="bg-gradient-to-br from-slate-800/40 to-slate-900/50 rounded-sm p-8 border-4 border-double border-amber-900/40 backdrop-blur-md shadow-2xl relative">
                  <div className="absolute top-4 left-4 text-6xl text-amber-900/10 font-serif">"</div>
                  <div className="absolute bottom-4 right-4 text-6xl text-amber-900/10 font-serif">"</div>

                  <div className="flex items-center gap-3 mb-4">
                    <${LucideIcon} name="Eye" className="w-5 h-5 text-amber-700" />
                    <h2 className="text-xl font-serif text-amber-100/90">Investigation Desk</h2>
                  </div>
                  <p className="text-amber-200/60 mb-6 text-sm font-serif italic">
                    Submit a source URL to trace its narrative mutations across the information network.
                  </p>

                  <div className="flex flex-col lg:flex-row gap-3">
                    <div className="flex-1 relative">
                      <${LucideIcon} name="Search" className="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-amber-700/50" />
                      <input
                        type="text"
                        value=${url}
                        onChange=${(e) => setUrl(e.target.value)}
                        placeholder="https://source-article.com/original-story"
                        className="w-full bg-black/60 border-2 border-amber-900/40 rounded-sm px-12 py-4 text-amber-100 placeholder-amber-700/40 focus:outline-none focus:border-amber-700/60 focus:ring-2 focus:ring-amber-700/20 font-mono text-sm"
                        onKeyPress=${(e) => e.key === 'Enter' && startAnalysis()}
                      />
                    </div>
                    <input
                      type="number"
                      min="1"
                      max="6"
                      value=${maxDepth}
                      onChange=${(e) => setMaxDepth(e.target.value)}
                      className="w-24 bg-black/60 border-2 border-amber-900/40 rounded-sm px-4 py-2 text-amber-100 font-mono text-sm"
                      title="Max Depth"
                    />
                    <button
                      onClick=${startAnalysis}
                      disabled=${isAnalyzing || !url}
                      className="px-8 py-4 bg-gradient-to-b from-amber-800 to-amber-900 rounded-sm font-serif uppercase text-sm tracking-wider hover:from-amber-700 hover:to-amber-800 disabled:opacity-50 disabled:cursor-not-allowed transition-all flex items-center gap-2 shadow-lg border border-amber-700/50"
                    >
                      ${renderTraceButton()}
                    </button>
                  </div>
                </div>
              </div>

              ${renderGraphGrid()}
              ${renderEmptyState()}

              <div className="mt-8 grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div className="bg-gradient-to-br from-slate-900/50 to-slate-800/40 rounded-sm p-6 border-2 border-amber-900/30 backdrop-blur-md shadow-2xl">
                  <h3 className="text-lg font-serif text-amber-100/90 mb-3 flex items-center gap-2">
                    <${LucideIcon} name="Globe" className="w-5 h-5 text-amber-700" />
                    Gemini Debrief
                  </h3>
                  <div className="summary-box text-sm font-serif text-amber-200/80">${summary}</div>
                </div>
                <div className="bg-gradient-to-br from-slate-900/50 to-slate-800/40 rounded-sm p-6 border-2 border-amber-900/30 backdrop-blur-md shadow-2xl">
                  <h3 className="text-lg font-serif text-amber-100/90 mb-3 flex items-center gap-2">
                    <${LucideIcon} name="Activity" className="w-5 h-5 text-amber-700" />
                    Gemini Chat
                  </h3>
                  <div className="chat-panel">
                    <div className="chat-messages">
                      ${chatMessages.map((entry, idx) => html`
                        <div key=${idx} className=${`chat-entry ${entry.role}`}>
                          <div className="avatar">${entry.role === 'assistant' ? 'G' : entry.role === 'user' ? 'You' : '!'}</div>
                          <div className="bubble">
                            <strong className="font-serif text-sm capitalize">${entry.role}</strong>
                            <p className="font-serif text-sm text-amber-100/90">${entry.text}</p>
                          </div>
                        </div>
                      `)}
                    </div>
                    <form onSubmit=${sendChatMessage} className="space-y-2">
                      <textarea
                        value=${chatInput}
                        onChange=${(e) => setChatInput(e.target.value)}
                        placeholder=${sessionId ? 'Ask Gemini about the findings...' : 'Chat unlocks once a trace completes.'}
                        disabled=${!sessionId}
                        className="w-full bg-black/60 border-2 border-amber-900/40 rounded-sm px-4 py-3 text-amber-100 placeholder-amber-700/40 focus:outline-none focus:border-amber-700/60 focus:ring-2 focus:ring-amber-700/20 font-serif text-sm"
                      ></textarea>
                      <button
                        type="submit"
                        disabled=${!sessionId}
                        className="px-6 py-2 bg-gradient-to-b from-amber-800 to-amber-900 rounded-sm font-serif uppercase text-xs tracking-wider hover:from-amber-700 hover:to-amber-800 disabled:opacity-50 disabled:cursor-not-allowed transition-all flex items-center gap-2 shadow-lg border border-amber-700/50"
                      >
                        <${LucideIcon} name="MessageCircle" className="w-4 h-4" />
                        Ask Gemini
                      </button>
                    </form>
                  </div>
                </div>
              </div>
            </div>

            <div className="border-t-2 border-amber-900/30 bg-black/20 mt-12">
              <div className="max-w-7xl mx-auto px-6 py-4 text-center">
                <p className="text-xs text-amber-700/60 font-serif italic">
                  Est. 2025 • Phylos Chronicle • Shedding Light on Digital Shadows
                </p>
              </div>
            </div>
          </div>
        `;
      }

      const root = document.getElementById('root');
      if (root) {
        ReactDOM.render(html`<${PhylosUI} />`, root);
      }
        } catch (error) {
          const root = document.getElementById('root');
          if (root) {
            root.innerHTML = `<div style="padding:16px;color:#fee;background:#7a0f0f;border:2px solid #ff5b5b;font-family:monospace;">
              UI failed to load:<br>${error.message}
            </div>`;
          }
          console.error("Phylos Chronicle UI error:", error);
        }
      })();
    </script>
  </body>
</html>
