<!-- UI Updated by Gemini -->
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Phylos Chronicle</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=UnifrakturMaguntia&family=Inter:wght@400;500;600;700&family=EB+Garamond:wght@400;500&display=swap"
    rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    * {
      transition: background-color 0.3s cubic-bezier(0.4, 0, 0.2, 1),
        border-color 0.3s cubic-bezier(0.4, 0, 0.2, 1),
        transform 0.3s cubic-bezier(0.4, 0, 0.2, 1),
        box-shadow 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Subtle paper texture overlay */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image:
        repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0, 0, 0, .03) 2px, rgba(0, 0, 0, .03) 4px),
        repeating-linear-gradient(90deg, transparent, transparent 2px, rgba(0, 0, 0, .03) 2px, rgba(0, 0, 0, .03) 4px);
      pointer-events: none;
      opacity: 0.4;
      z-index: 1;
    }

    #root {
      position: relative;
      z-index: 2;
    }

    .summary-box {
      padding: 12px;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.04);
      min-height: 120px;
      white-space: pre-wrap;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 16px;
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.4), rgba(30, 41, 59, 0.3));
      border: 2px solid rgba(251, 191, 36, 0.15);
      border-radius: 16px;
      padding: 20px;
      min-height: 0;
      box-shadow: inset 0 2px 12px rgba(0, 0, 0, 0.3);
    }

    .chat-entry {
      display: flex;
      gap: 14px;
      align-items: flex-start;
      animation: slideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .chat-entry.user {
      flex-direction: row-reverse;
      text-align: right;
    }

    .chat-entry .avatar {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(217, 119, 6, 0.15));
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.85rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4), 0 0 20px rgba(251, 191, 36, 0.1);
      border: 2px solid rgba(251, 191, 36, 0.25);
    }

    .custom-scrollbar::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 4px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, #92400e 0%, #78350f 100%);
      border-radius: 4px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(180deg, #a85a1a 0%, #92400e 100%);
    }

    .chat-entry.assistant .avatar {
      background: linear-gradient(135deg, rgba(146, 112, 255, 0.5), rgba(146, 112, 255, 0.3));
      color: #ffffff;
      border-color: rgba(146, 112, 255, 0.4);
    }

    .chat-entry.system .avatar {
      background: linear-gradient(135deg, rgba(255, 193, 59, 0.4), rgba(255, 193, 59, 0.25));
      color: #2d1a00;
      border-color: rgba(255, 193, 59, 0.5);
    }

    .chat-entry.user .avatar {
      background: linear-gradient(135deg, rgba(109, 255, 214, 0.4), rgba(43, 166, 255, 0.3));
      color: #ffffff;
      border-color: rgba(109, 255, 214, 0.5);
    }

    .chat-entry .bubble {
      border-radius: 18px;
      padding: 14px 18px;
      border: 2px solid rgba(251, 191, 36, 0.15);
      background: linear-gradient(135deg, rgba(251, 191, 36, 0.05), rgba(217, 119, 6, 0.03));
      max-width: 85%;
      word-break: break-word;
      overflow-wrap: break-word;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3), 0 0 30px rgba(251, 191, 36, 0.05);
    }

    .chat-entry.user .bubble {
      background: linear-gradient(135deg, rgba(109, 255, 214, 0.25), rgba(43, 166, 255, 0.2));
      border-color: rgba(109, 255, 214, 0.4);
    }

    .chat-entry.assistant .bubble {
      background: rgba(146, 112, 255, 0.18);
      border-color: rgba(146, 112, 255, 0.4);
    }

    .chat-entry.system .bubble {
      background: rgba(255, 193, 59, 0.15);
      border-color: rgba(255, 193, 59, 0.4);
    }

    .card-hover {
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .card-hover:hover {
      transform: translateY(-4px) scale(1.01);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.5), 0 0 60px rgba(251, 191, 36, 0.15);
    }

    @keyframes pulse-glow {

      0%,
      100% {
        box-shadow: 0 0 20px rgba(251, 191, 36, 0.3);
      }

      50% {
        box-shadow: 0 0 40px rgba(251, 191, 36, 0.6);
      }
    }

    @keyframes vizFadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes nodePulse {

      0%,
      100% {
        transform: scale(1);
        opacity: 0.8;
      }

      50% {
        transform: scale(1.1);
        opacity: 1;
      }
    }

    @keyframes drawLine {
      from {
        stroke-dashoffset: 1000;
      }

      to {
        stroke-dashoffset: 0;
      }
    }

    @keyframes tableRowFadeIn {
      from {
        opacity: 0;
        transform: translateX(-10px);
      }

      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .viz-container {
      animation: vizFadeIn 0.5s ease-out;
    }

    .viz-node {
      animation: nodePulse 1s ease-in-out forwards;
    }

    .viz-line {
      stroke-dasharray: 1000;
      stroke-dashoffset: 1000;
      animation: drawLine 0.3s ease-out forwards;
    }

    .table-row-animated {
      animation: tableRowFadeIn 0.3s ease-out forwards;
      opacity: 0;
    }

    .glow-on-hover:hover {
      animation: pulse-glow 2s ease-in-out infinite;
    }
  </style>
</head>

<body class="min-h-screen bg-gradient-to-b from-slate-900 via-blue-950 to-indigo-950 text-gray-100">
  <div id="root"></div>

  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script type="text/babel" data-presets="react">
    (function () {
      try {
        const { useState, useEffect, useRef } = React;

        const iconSlug = (name) =>
          name
            .replace(/([a-z0-9])([A-Z])/g, '$1-$2')
            .replace(/([A-Za-z])(\d+)/g, '$1-$2')
            .toLowerCase();

        const LucideIcon = ({ name, className }) => (
          <i data-lucide={iconSlug(name)} className={className}></i>
        );

        const formatTimestamp = (timestamp) => {
          if (!timestamp) return 'Unknown';
          try {
            return new Date(timestamp).toLocaleString();
          } catch (err) {
            return timestamp;
          }
        };

        const buildMutationEvents = (edges = [], nodes = []) => {
          const nodeMap = nodes.reduce((acc, node) => {
            acc[node.id] = node;
            return acc;
          }, {});
          return edges
            .filter((edge) => edge.attributes?.relation_type === 'Mutation')
            .sort((a, b) => (b.attributes?.mutation_score ?? 0) - (a.attributes?.mutation_score ?? 0))
            .slice(0, 5)
            .map((edge) => {
              const nodeInfo = nodeMap[edge.target] || {};
              return {
                node: edge.target,
                score: edge.attributes?.mutation_score ?? 0,
                type: 'mutation',
                timestamp: nodeInfo.timestamp || 'N/A',
                title: nodeInfo.content?.slice(0, 80) || edge.target,
                url: nodeInfo.url || edge.target,
              };
            });
        };

        const DEPTH_CHOICES = [1, 2, 3, 4, 5, 6];

        const normalizeWhitespace = (text = '') => text.replace(/\s+/g, ' ').trim();

        const extractHeadline = (content, fallback = '') => {
          if (!content) return fallback;
          const lines = content.split('\n').map((line) => line.trim()).filter(Boolean);
          return lines[0] || fallback;
        };

        const extractSummary = (content) => {
          if (!content) return '';
          const [body] = content.split('Referenced URLs:');
          const normalized = normalizeWhitespace(body);
          if (normalized.length <= 220) {
            return normalized;
          }
          return `${normalized.slice(0, 220)}…`;
        };

        const extractReferences = (links) => {
          if (!Array.isArray(links)) {
            return [];
          }
          return links.map((link) => (typeof link === 'string' ? link.trim() : '')).filter(Boolean);
        };

        const clampStyle = (lines) => ({
          display: '-webkit-box',
          WebkitLineClamp: lines,
          WebkitBoxOrient: 'vertical',
          overflow: 'hidden',
        });

        const renderMarkdown = (text) => {
          const raw = text || '';
          try {
            if (window.marked && window.DOMPurify) {
              const html = window.marked.parse(raw, { breaks: true });
              return { __html: window.DOMPurify.sanitize(html) };
            }
          } catch (error) {
            console.warn('Markdown rendering failed, falling back to plaintext.', error);
          }
          const escaped = raw
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/\n/g, '<br />');
          return { __html: escaped };
        };

        const FALLBACK_MODEL_OPTIONS = [
          { id: 'gemini-2.5-flash', label: 'Gemini 2.5 Flash' },
          { id: 'gemini-2.5-pro', label: 'Gemini 2.5 Pro' },
          { id: 'gemini-2.0-flash', label: 'Gemini 2.0 Flash' },
          { id: 'gemini-2.0-flash-exp', label: 'Gemini 2.0 Flash (Experimental)' },
        ];

        const formatPercent = (value) => (
          typeof value === 'number' ? `${(value * 100).toFixed(1)}%` : 'n/a'
        );

        const parseTimestamp = (value) => {
          const ts = Date.parse(value);
          return Number.isNaN(ts) ? null : ts;
        };

        const enrichNodes = (graph) => {
          const edges = graph.edges || [];
          const scoreMap = edges.reduce((acc, edge) => {
            if (edge.target) {
              acc[edge.target] = edge.attributes?.mutation_score ?? 0;
            }
            return acc;
          }, {});
          const rawNodes = Array.isArray(graph.nodes) ? graph.nodes : [];
          const mapped = rawNodes.map((node) => {
            const id = node.id;
            const mutationScore = typeof node.mutation_score === 'number'
              ? node.mutation_score
              : (scoreMap[id] ?? 0);
            const references = extractReferences(node.outbound_links).slice(0, 12);
            return {
              id,
              title: extractHeadline(node.content, id),
              summary: extractSummary(node.content),
              url: id,
              mutationScore,
              timestamp: node.timestamp,
              timestampValue: parseTimestamp(node.timestamp),
              author: node.author || 'Unknown',
              depth: node.depth || 0,
              content: node.content || '',
              references,
              originSimilarity: typeof node.origin_similarity === 'number' ? node.origin_similarity : null,
              originDifference: typeof node.origin_difference === 'number' ? node.origin_difference : (
                typeof node.origin_similarity === 'number' ? 1 - node.origin_similarity : null
              ),
              originSummary: (() => {
                const summary = node.origin_summary;
                if (!summary) return null;
                if (typeof summary === 'string') return summary;
                if (typeof summary === 'object') {
                  // Handle structured Deep Analysis output
                  if (summary.summary) return summary.summary;
                  // Format key-value pairs if no main summary field
                  return Object.entries(summary)
                    .map(([k, v]) => `**${k}**: ${typeof v === 'object' ? JSON.stringify(v) : v}`)
                    .join('\n\n');
                }
                return String(summary);
              })(),
            };
          });
          return mapped.sort((a, b) => {
            const ta = a.timestampValue;
            const tb = b.timestampValue;
            if (ta === null && tb === null) {
              return a.title.localeCompare(b.title);
            }
            if (ta === null) return 1;
            if (tb === null) return -1;
            return ta - tb;
          });
        };

        function PhylosUI() {
          const [url, setUrl] = useState('');
          const [maxDepth, setMaxDepth] = useState(3);
          const [isAnalyzing, setIsAnalyzing] = useState(false);
          const [modelOptions, setModelOptions] = useState(FALLBACK_MODEL_OPTIONS);
          const [selectedModel, setSelectedModel] = useState(FALLBACK_MODEL_OPTIONS[0]?.id || '');
          const [graphData, setGraphData] = useState({ nodes: [], edges: [], origin: {}, timeline: [] });
          const [timelineEntries, setTimelineEntries] = useState([]);
          const timelineRef = useRef(null);
          const [selectedNode, setSelectedNode] = useState(null);
          const [vizMode, setVizMode] = useState('network'); // 'network', 'chart', 'table'
          const [mutationEvents, setMutationEvents] = useState([]);
          const [telemetry, setTelemetry] = useState({ events: 0, nodes: 0, mutations: 0, replications: 0 });
          const [summary, setSummary] = useState('Submit a URL to begin a trace.');
          const [showHelp, setShowHelp] = useState(false);
          const [helpSearch, setHelpSearch] = useState('');
          const [sessionId, setSessionId] = useState(null);
          const [hoverNode, setHoverNode] = useState(null);
          const [chatMessages, setChatMessages] = useState([
            { role: 'system', text: 'Submit a source URL and select "Trace Origin" to begin.' },
          ]);
          const [chatInput, setChatInput] = useState('');
          const wsRef = useRef(null);
          const chatEndRef = useRef(null);

          useEffect(() => {
            return () => {
              if (wsRef.current) {
                wsRef.current.close();
              }
            };
          }, []);

          useEffect(() => {
            let cancelled = false;
            const hydrateModels = async () => {
              try {
                const response = await fetch('/models');
                if (!response.ok) {
                  throw new Error('Failed to fetch models');
                }
                const payload = await response.json();
                if (cancelled) return;
                const options = Array.isArray(payload.models) && payload.models.length
                  ? payload.models
                  : FALLBACK_MODEL_OPTIONS;
                setModelOptions(options);
                const defaultChoice = payload.default && options.some((opt) => opt.id === payload.default)
                  ? payload.default
                  : (options[0]?.id || FALLBACK_MODEL_OPTIONS[0]?.id || '');
                setSelectedModel((prev) => (
                  prev && options.some((opt) => opt.id === prev)
                    ? prev
                    : defaultChoice
                ));
              } catch (error) {
                if (cancelled) return;
                setModelOptions((prev) => prev.length ? prev : FALLBACK_MODEL_OPTIONS);
                setSelectedModel((prev) => prev || (FALLBACK_MODEL_OPTIONS[0]?.id || ''));
              }
            };
            hydrateModels();
            return () => {
              cancelled = true;
            };
          }, []);

          // useEffect(() => {
          //   if (window.lucide && typeof window.lucide.createIcons === 'function') {
          //     window.lucide.createIcons();
          //   }
          // });

          const appendMessage = (role, text) => {
            setChatMessages((prev) => [...prev, { role, text }]);
          };

          useEffect(() => {
            if (timelineRef.current) {
              timelineRef.current.scrollTop = timelineRef.current.scrollHeight;
            }
          }, [timelineEntries]);

          useEffect(() => {
            if (chatEndRef.current) {
              chatEndRef.current.scrollIntoView({ behavior: "smooth" });
            }
          }, [chatMessages]);

          // Initialize Chart.js pie chart for mutation distribution
          useEffect(() => {
            if (vizMode === 'chart' && graphData.nodes.length > 0 && window.Chart) {
              const ctx = document.getElementById('mutationChart');
              if (!ctx) return;

              // Count mutation types
              const replication = graphData.nodes.filter(n => (n.mutationScore || 0) < 0.2).length;
              const mutation = graphData.nodes.filter(n => (n.mutationScore || 0) >= 0.2 && (n.mutationScore || 0) < 0.5).length;
              const majorVariation = graphData.nodes.filter(n => (n.mutationScore || 0) >= 0.5 && (n.mutationScore || 0) < 0.8).length;
              const anomaly = graphData.nodes.filter(n => (n.mutationScore || 0) >= 0.8).length;

              // Destroy previous chart if exists
              if (ctx._chartInstance) {
                ctx._chartInstance.destroy();
              }

              // Create new pie chart
              ctx._chartInstance = new Chart(ctx, {
                type: 'pie',
                data: {
                  labels: ['Replication', 'Mutation', 'Major Variation', 'Anomaly'],
                  datasets: [{
                    data: [replication, mutation, majorVariation, anomaly],
                    backgroundColor: ['#10b981', '#f59e0b', '#fb923c', '#ef4444'],
                    borderColor: ['#064e3b', '#78350f', '#7c2d12', '#7f1d1d'],
                    borderWidth: 2
                  }]
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: true,
                  animation: {
                    animateRotate: true,
                    animateScale: true,
                    duration: 1500,
                    easing: 'easeInOutQuart'
                  },
                  plugins: {
                    legend: {
                      position: 'bottom',
                      labels: { color: '#fbbf24', font: { family: 'serif', size: 12 } }
                    },
                    title: {
                      display: true,
                      text: 'Mutation Type Distribution',
                      color: '#fbbf24',
                      font: { family: 'serif', size: 16 }
                    }
                  }
                }
              });
            }
          }, [vizMode, graphData.nodes]);

          const fetchGraphSnapshot = async (id) => {
            try {
              const response = await fetch(`/session/${id}/graph`);
              if (!response.ok) {
                throw new Error('Failed to load graph snapshot');
              }
              const payload = await response.json();
              const enrichedNodes = enrichNodes(payload);
              const timeline = payload.investigation_timeline || [];
              setGraphData({
                nodes: enrichedNodes,
                edges: payload.edges || [],
                origin: payload.origin || {},
                timeline,
              });
              setTimelineEntries(timeline);
              if (enrichedNodes.length) {
                setSelectedNode(enrichedNodes[0]);
              }
              setMutationEvents(buildMutationEvents(payload.edges, enrichedNodes));
              setTelemetry((prev) => ({
                ...prev,
                nodes: payload.stats?.nodes ?? prev.nodes,
                mutations: payload.stats?.mutations ?? prev.mutations,
                replications: payload.stats?.replications ?? prev.replications,
              }));
            } catch (error) {
              console.error(error);
              appendMessage('system', 'Unable to load final graph snapshot.');
            }
          };

          const handleSocketMessage = (message) => {
            if (message.status) {
              if (message.status === 'session') {
                setSessionId(message.session_id);
                appendMessage('system', `Session established (${message.session_id.slice(0, 8)}…).`);
                return;
              }
              if (message.status === 'summary') {
                setSummary(message.summary || 'Summary unavailable.');
                appendMessage('assistant', 'Trace complete. Ask me what you would like to investigate.');
                setIsAnalyzing(false);
                if (message.session_id) {
                  fetchGraphSnapshot(message.session_id);
                } else if (sessionId) {
                  fetchGraphSnapshot(sessionId);
                }
                return;
              }
              if (message.status === 'investigation') {
                const entry = message.entry;
                if (entry) {
                  setTimelineEntries((prev) => {
                    const next = [...prev, entry];
                    setGraphData((current) => current ? { ...current, timeline: next } : current);
                    return next;
                  });
                }
                return;
              }
              if (message.status === 'investigation_update') {
                const entry = message.entry;
                if (entry) {
                  setTimelineEntries((prev) => {
                    const updated = prev.map((item) =>
                      item.id === entry.id ? { ...item, ...entry } : item
                    );
                    setGraphData((current) => current ? { ...current, timeline: updated } : current);
                    return updated;
                  });
                }
                return;
              }
              if (message.status === 'info') {
                appendMessage('system', message.message || 'Info update received.');
                return;
              }
              if (message.status === 'error') {
                appendMessage('system', message.message || 'An error occurred.');
                setIsAnalyzing(false);
                return;
              }
            }

            if (message.event) {
              const data = message.data || {};
              const knowledgeGraph = data.knowledge_graph || {};
              const edgeStats = data.edge_stats || {};
              setTelemetry((prev) => {
                const nodeCount = typeof knowledgeGraph.node_count === 'number' ? knowledgeGraph.node_count : prev.nodes;
                const mutationIncrement = typeof edgeStats.mutation_count === 'number' ? edgeStats.mutation_count : 0;
                const replicationIncrement = typeof edgeStats.replication_count === 'number' ? edgeStats.replication_count : 0;
                return {
                  events: prev.events + 1,
                  nodes: Math.max(prev.nodes, nodeCount),
                  mutations: prev.mutations + mutationIncrement,
                  replications: prev.replications + replicationIncrement,
                };
              });
            }
          };

          const startAnalysis = () => {
            if (!url || isAnalyzing) return;
            const normalizedDepth = Math.min(6, Math.max(1, Number(maxDepth) || 1));
            if (normalizedDepth !== maxDepth) {
              setMaxDepth(normalizedDepth);
            }
            setIsAnalyzing(true);
            setGraphData({ nodes: [], edges: [], origin: {}, timeline: [] });
            setTimelineEntries([]);
            setSelectedNode(null);
            setMutationEvents([]);
            setTelemetry({ events: 0, nodes: 0, mutations: 0, replications: 0 });
            setSummary('Tracing narrative lineage...');
            setChatMessages([{ role: 'system', text: 'Investigation running… chat will unlock once complete.' }]);
            if (wsRef.current) {
              wsRef.current.close();
            }
            const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
            const wsUrl = `${protocol}://${window.location.host}/ws/dna-stream`;
            const ws = new WebSocket(wsUrl);
            wsRef.current = ws;

            ws.onopen = () => {
              ws.send(JSON.stringify({ start_url: url, max_depth: normalizedDepth }));
            };
            ws.onmessage = (event) => {
              try {
                const payload = JSON.parse(event.data);
                handleSocketMessage(payload);
              } catch (error) {
                console.error('Failed to parse WebSocket message', error);
              }
            };
            ws.onerror = () => {
              appendMessage('system', 'WebSocket error encountered.');
              setIsAnalyzing(false);
            };
            ws.onclose = () => {
              setIsAnalyzing(false);
            };
          };

          const sendChatMessage = async (evt) => {
            evt.preventDefault();
            if (!chatInput.trim() || !sessionId) {
              return;
            }
            const message = chatInput.trim();
            setChatInput('');
            appendMessage('user', message);
            try {
              const response = await fetch('/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  session_id: sessionId,
                  question: message,
                  model: selectedModel || undefined
                }),
              });
              const payload = await response.json();
              if (!response.ok) {
                appendMessage('system', payload.detail || 'Chat failed.');
                return;
              }
              appendMessage('assistant', payload.reply || 'I need more context.');
            } catch (error) {
              appendMessage('system', 'Unable to reach chat endpoint.');
            }
          };

          const getMutationColor = (score) => {
            if (score < 0.2) return 'bg-emerald-800';
            if (score < 0.5) return 'bg-amber-700';
            return 'bg-red-900';
          };

          const getMutationLabel = (score) => {
            if (score < 0.2) return 'Authentic';
            if (score < 0.5) return 'Modified';
            return 'Corrupted';
          };

          const averageMutation = graphData?.nodes?.length
            ? graphData.nodes.reduce((acc, node) => acc + (node.mutationScore || 0), 0) / graphData.nodes.length
            : 0;
          const earliestNode = graphData?.nodes?.[0] || null;
          const originMatchScore = earliestNode?.originSimilarity ?? null;

          return (
            <div className="min-h-screen bg-gradient-to-b from-slate-900 via-blue-950 to-indigo-950 text-gray-100">
              {/* Static newspaper texture overlay */}
              <div className="fixed inset-0 opacity-5 pointer-events-none" style={{
                backgroundImage: `url("data:image/svg+xml,%3Csvg width='100' height='100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' /%3E%3C/filter%3E%3Crect width='100' height='100' filter='url(%23noise)' opacity='0.4'/%3E%3C/svg%3E")`,
                zIndex: 2
              }} />

              {/* Header with old newspaper masthead style */}
              <div className="border-b-4 border-double border-amber-800/40 bg-gradient-to-b from-black/50 to-black/30 backdrop-blur-md relative overflow-hidden shadow-2xl">
                <div className="absolute inset-0 bg-gradient-to-r from-transparent via-amber-900/8 to-transparent animate-pulse-slow" />
                {/* Decorative corner ornaments */}
                <div className="absolute top-4 left-4 w-12 h-12 border-t-2 border-l-2 border-amber-700/30" />
                <div className="absolute top-4 right-4 w-12 h-12 border-t-2 border-r-2 border-amber-700/30" />
                <div className="w-full mx-auto px-3 py-8 relative">
                  <div className="text-center border-b-2 border-double border-amber-800/25 pb-6 mb-5">
                    <div className="flex items-center justify-center mb-3">
                      <div className="h-px w-48 bg-gradient-to-r from-transparent via-amber-600/60 to-transparent" />
                    </div>
                    <h1 className="text-7xl mb-3 text-transparent bg-clip-text bg-gradient-to-b from-amber-200 via-amber-100 to-amber-300/80 tracking-wider drop-shadow-2xl" style={{
                      fontFamily: '"UnifrakturMaguntia", "Old English Text MT", "Blackletter", serif',
                      textShadow: '3px 3px 8px rgba(0,0,0,0.8), 0 0 40px rgba(251, 191, 36, 0.2)',
                      fontWeight: 400,
                      letterSpacing: '0.05em'
                    }}>
                      Phylos
                    </h1>
                    <style>{`
                    @import url('https://fonts.googleapis.com/css2?family=UnifrakturMaguntia&display=swap');
                    @keyframes pulse-slow {
                      0%, 100% { opacity: 0.3; }
                      50% { opacity: 0.6; }
                    }
                  `}</style>
                    <div className="flex items-center justify-center gap-3 text-xs text-amber-600/90 uppercase tracking-[0.3em] font-semibold">
                      <div className="h-px w-16 bg-gradient-to-r from-transparent to-amber-700/50" />
                      <span className="drop-shadow-lg">Narrative Evolution Chronicle</span>
                      <div className="h-px w-16 bg-gradient-to-l from-transparent to-amber-700/50" />
                    </div>
                  </div>
                  <p className="text-center text-sm text-amber-200/70 italic font-serif leading-relaxed px-8" style={{
                    textShadow: '1px 1px 3px rgba(0,0,0,0.5)'
                  }}>
                    "Tracing the Lineage of Truth Through the Shadows of Disinformation"
                  </p>
                </div>
                {/* Bottom decorative border */}
                <div className="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-amber-700/30 to-transparent" />
              </div>

              {/* SEARCHABLE HELP DOCUMENTATION */}
              <div className="w-full mx-auto px-3 py-4 bg-black/30 backdrop-blur-sm border-b border-amber-900/30">
                <button onClick={() => setShowHelp(!showHelp)} className="w-full flex items-center justify-between px-4 py-3 bg-gradient-to-r from-amber-900/30 to-amber-800/20 border border-amber-700/40 rounded hover:from-amber-800/40 hover:to-amber-700/30 transition-all duration-300">
                  <div className="flex items-center gap-3">
                    <LucideIcon name={"HelpCircle"} className="w-5 h-5 text-amber-500" />
                    <span className="font-serif text-amber-100">User Guide & Documentation</span>
                  </div>
                  <LucideIcon name={showHelp ? "ChevronUp" : "ChevronDown"} className="w-5 h-5 text-amber-500" />
                </button>

                {showHelp && (
                  <div className="mt-4 bg-slate-900/80 border border-amber-900/30 rounded p-6 viz-container">
                    {/* Search Bar */}
                    <div className="mb-6">
                      <div className="relative">
                        <LucideIcon name="Search" className="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-amber-600" />
                        <input type="text" value={helpSearch} onChange={(e) => setHelpSearch(e.target.value)} placeholder="Search guide..." className="w-full pl-10 pr-4 py-2 bg-black/40 border border-amber-900/40 rounded text-amber-100 text-sm focus:outline-none focus:border-amber-700/60 focus:ring-2 focus:ring-amber-700/20" />
                      </div>
                    </div>

                    {/* Help Content - Only shown if matches search */}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 text-sm">

                      {/* Quick Start */}
                      {(!helpSearch || 'quick start trace url'.includes(helpSearch.toLowerCase())) && (
                        <div className="bg-black/30 border border-amber-900/20 p-4 rounded">
                          <h3 className="text-amber-300 font-serif font-bold mb-3 flex items-center gap-2">
                            <LucideIcon name="Play" className="w-4 h-4" />
                            Quick Start
                          </h3>
                          <ol className="space-y-2 text-amber-200/70 text-xs">
                            <li><strong className="text-amber-300">1.</strong> Paste a news article URL in the input field</li>
                            <li><strong className="text-amber-300">2.</strong> Click "Trace Origin" to analyze</li>
                            <li><strong className="text-amber-300">3.</strong> View results in Citation Network, Investigation Data, and Chat</li>
                            <li><strong className="text-amber-300">4.</strong> Use Data Visualization for charts and tables</li>
                          </ol>
                        </div>
                      )}

                      {/* Color Coding */}
                      {(!helpSearch || 'color green orange red mutation'.includes(helpSearch.toLowerCase())) && (
                        <div className="bg-black/30 border border-amber-900/20 p-4 rounded">
                          <h3 className="text-amber-300 font-serif font-bold mb-3 flex items-center gap-2">
                            <LucideIcon name="Palette" className="w-4 h-4" />
                            Color Coding
                          </h3>
                          <div className="space-y-2 text-xs">
                            <div className="flex items-center gap-2">
                              <div className="w-4 h-4 bg-emerald-800 border border-emerald-600 rounded" />
                              <span className="text-amber-200/70"><strong className="text-emerald-300">Green:</strong> Authentic/Replication (mutation &lt; 0.2)</span>
                            </div>
                            <div className="flex items-center gap-2">
                              <div className="w-4 h-4 bg-amber-700 border border-amber-500 rounded" />
                              <span className="text-amber-200/70"><strong className="text-amber-300">Orange:</strong> Modified (mutation 0.2-0.5)</span>
                            </div>
                            <div className="flex items-center gap-2">
                              <div className="w-4 h-4 bg-red-900 border border-red-700 rounded" />
                              <span className="text-amber-200/70"><strong className="text-red-300">Red:</strong> Corrupted (mutation &gt; 0.5)</span>
                            </div>
                          </div>
                        </div>
                      )}

                      {/* Mutation Scores */}
                      {(!helpSearch || 'mutation score number meaning'.includes(helpSearch.toLowerCase())) && (
                        <div className="bg-black/30 border border-amber-900/20 p-4 rounded">
                          <h3 className="text-amber-300 font-serif font-bold mb-3 flex items-center gap-2">
                            <LucideIcon name="Activity" className="w-4 h-4" />
                            Mutation Scores
                          </h3>
                          <div className="space-y-2 text-amber-200/70 text-xs">
                            <p><strong className="text-amber-300">0.000-0.199:</strong> Replication - Near-identical content</p>
                            <p><strong className="text-amber-300">0.200-0.499:</strong> Mutation - Moderate changes</p>
                            <p><strong className="text-amber-300">0.500-0.799:</strong> Major Variation - Significant divergence</p>
                            <p><strong className="text-amber-300">0.800-1.000:</strong> Anomaly - Completely different narrative</p>
                          </div>
                        </div>
                      )}

                      {/* Network View */}
                      {(!helpSearch || 'network view graph node circle number'.includes(helpSearch.toLowerCase())) && (
                        <div className="bg-black/30 border border-amber-900/20 p-4 rounded">
                          <h3 className="text-amber-300 font-serif font-bold mb-3 flex items-center gap-2">
                            <LucideIcon name="Network" className="w-4 h-4" />
                            Network View
                          </h3>
                          <div className="space-y-2 text-amber-200/70 text-xs">
                            <p><strong className="text-amber-300">Circles:</strong> Each represents an article in the trace</p>
                            <p><strong className="text-amber-300">Numbers (1,2,3...):</strong> Discovery order (1 = original source)</p>
                            <p><strong className="text-amber-300">Click nodes:</strong> View full article details</p>
                            <p className="text-amber-400/60 italic">Shows up to 8 articles at once</p>
                          </div>
                        </div>
                      )}

                      {/* Data Visualization */}
                      {(!helpSearch || 'visualization chart table distribution'.includes(helpSearch.toLowerCase())) && (
                        <div className="bg-black/30 border border-amber-900/20 p-4 rounded">
                          <h3 className="text-amber-300 font-serif font-bold mb-3 flex items-center gap-2">
                            <LucideIcon name="BarChart3" className="w-4 h-4" />
                            Data Visualization
                          </h3>
                          <div className="space-y-2 text-amber-200/70 text-xs">
                            <p><strong className="text-amber-300">Network:</strong> Visual article flow diagram</p>
                            <p><strong className="text-amber-300">Distribution:</strong> Pie chart of mutation types</p>
                            <p><strong className="text-amber-300">Data Table:</strong> Exportable detailed data</p>
                            <p className="text-amber-400/60 italic">Toggle between views with buttons</p>
                          </div>
                        </div>
                      )}

                      {/* Chat Assistant */}
                      {(!helpSearch || 'chat ai gemini ask question'.includes(helpSearch.toLowerCase())) && (
                        <div className="bg-black/30 border border-amber-900/20 p-4 rounded">
                          <h3 className="text-amber-300 font-serif font-bold mb-3 flex items-center gap-2">
                            <LucideIcon name="MessageSquare" className="w-4 h-4" />
                            Chat Assistant
                          </h3>
                          <div className="space-y-2 text-amber-200/70 text-xs">
                            <p><strong className="text-amber-300">Ask questions:</strong> About trace results and anomalies</p>
                            <p><strong className="text-amber-300">Select model:</strong> Choose Gemini version from dropdown</p>
                            <p><strong className="text-amber-300">Natural language:</strong> Ask anything related to the trace</p>
                            <p className="text-amber-400/60 italic">Available after trace completes</p>
                          </div>
                        </div>
                      )}

                      {/* Symbols & Icons */}
                      {(!helpSearch || 'symbol icon shield alert triangle'.includes(helpSearch.toLowerCase())) && (
                        <div className="bg-black/30 border border-amber-900/20 p-4 rounded">
                          <h3 className="text-amber-300 font-serif font-bold mb-3 flex items-center gap-2">
                            <LucideIcon name="Info" className="w-4 h-4" />
                            Symbols & Icons
                          </h3>
                          <div className="space-y-2 text-amber-200/70 text-xs flex flex-col">
                            <div className="flex items-center gap-2"><LucideIcon name="Shield" className="w-4 h-4 text-emerald-400" /><span>Authentic article</span></div>
                            <div className="flex items-center gap-2"><LucideIcon name="TrendingUp" className="w-4 h-4 text-amber-400" /><span>Modified content</span></div>
                            <div className="flex items-center gap-2"><LucideIcon name="AlertTriangle" className="w-4 h-4 text-red-400" /><span>Corrupted/Anomaly</span></div>
                            <div className="flex items-center gap-2"><LucideIcon name="ExternalLink" className="w-4 h-4 text-amber-600" /><span>Link to source</span></div>
                          </div>
                        </div>
                      )}

                      {/* Origin Similarity */}
                      {(!helpSearch || 'origin similarity match'.includes(helpSearch.toLowerCase())) && (
                        <div className="bg-black/30 border border-amber-900/20 p-4 rounded">
                          <h3 className="text-amber-300 font-serif font-bold mb-3 flex items-center gap-2">
                            <LucideIcon name="Target" className="w-4 h-4" />
                            Origin Similarity
                          </h3>
                          <div className="space-y-2 text-amber-200/70 text-xs">
                            <p><strong className="text-amber-300">1.00 (100%):</strong> Identical to original</p>
                            <p><strong className="text-amber-300">0.75-0.99:</strong> Very similar</p>
                            <p><strong className="text-amber-300">0.50-0.74:</strong> Moderately similar</p>
                            <p><strong className="text-amber-300">&lt;0.50:</strong> Significantly different</p>
                          </div>
                        </div>
                      )}

                      {/* Troubleshooting */}
                      {(!helpSearch || 'troubleshoot error non-ai analysis quota 429'.includes(helpSearch.toLowerCase())) && (
                        <div className="bg-black/30 border border-amber-900/20 p-4 rounded">
                          <h3 className="text-amber-300 font-serif font-bold mb-3 flex items-center gap-2">
                            <LucideIcon name="AlertCircle" className="w-4 h-4" />
                            Troubleshooting
                          </h3>
                          <div className="space-y-2 text-amber-200/70 text-xs">
                            <p><strong className="text-amber-300">[Non-AI Analysis]:</strong> API quota exceeded - wait or upgrade plan</p>
                            <p><strong className="text-amber-300">No results:</strong> URL may be paywalled or blocked</p>
                            <p><strong className="text-amber-300">Slow trace:</strong> Deep traces take time - be patient</p>
                            <p><strong className="text-amber-300">Old data showing:</strong> Restart container for fresh trace</p>
                          </div>
                        </div>
                      )}

                      {/* Tips & Best Practices */}
                      {(!helpSearch || 'tips best practices advice'.includes(helpSearch.toLowerCase())) && (
                        <div className="bg-black/30 border border-amber-900/20 p-4 rounded">
                          <h3 className="text-amber-300 font-serif font-bold mb-3 flex items-center gap-2">
                            <LucideIcon name="Lightbulb" className="w-4 h-4" />
                            Tips & Best Practices
                          </h3>
                          <div className="space-y-2 text-amber-200/70 text-xs">
                            <p><strong className="text-amber-300">Start with recent news:</strong> More likely to have citations</p>
                            <p><strong className="text-amber-300">Use max depth 3-4:</strong> Balance coverage vs speed</p>
                            <p><strong className="text-amber-300">Check timeline:</strong> Chronological order shows narrative evolution</p>
                            <p><strong className="text-amber-300">Export data table:</strong> Copy for further analysis in Excel/Sheets</p>
                          </div>
                        </div>
                      )}

                      {/* Understanding Depth */}
                      {(!helpSearch || 'depth level max recursive'.includes(helpSearch.toLowerCase())) && (
                        <div className="bg-black/30 border border-amber-900/20 p-4 rounded">
                          <h3 className="text-amber-300 font-serif font-bold mb-3 flex items-center gap-2">
                            <LucideIcon name="Layers" className="w-4 h-4" />
                            Understanding Depth
                          </h3>
                          <div className="space-y-2 text-amber-200/70 text-xs">
                            <p><strong className="text-amber-300">Depth 1:</strong> Only direct citations of original</p>
                            <p><strong className="text-amber-300">Depth 2:</strong> Citations of citations (2 hops)</p>
                            <p><strong className="text-amber-300">Depth 3+:</strong> Extended propagation network</p>
                            <p className="text-amber-400/60 italic">Higher depth = more articles but slower</p>
                          </div>
                        </div>
                      )}

                      {/* Eco Mode */}
                      {(!helpSearch || 'eco mode cost free gemini'.includes(helpSearch.toLowerCase())) && (
                        <div className="bg-black/30 border border-amber-900/20 p-4 rounded">
                          <h3 className="text-amber-300 font-serif font-bold mb-3 flex items-center gap-2">
                            <LucideIcon name="Zap" className="w-4 h-4" />
                            Eco Mode
                          </h3>
                          <div className="space-y-2 text-amber-200/70 text-xs">
                            <p><strong className="text-amber-300">What is it:</strong> Run traces without Gemini API calls</p>
                            <p><strong className="text-amber-300">Trade-off:</strong> Faster & free but shows [Non-AI Analysis]</p>
                            <p><strong className="text-amber-300">Enable:</strong> Set PHYLOS_ECO_MODE=true in environment</p>
                            <p className="text-amber-400/60 italic">Good for testing or quota-limited situations</p>
                          </div>
                        </div>
                      )}

                      {/* Reading the Timeline */}
                      {(!helpSearch || 'timeline chronological order history'.includes(helpSearch.toLowerCase())) && (
                        <div className="bg-black/30 border border-amber-900/20 p-4 rounded">
                          <h3 className="text-amber-300 font-serif font-bold mb-3 flex items-center gap-2">
                            <LucideIcon name="Clock" className="w-4 h-4" />
                            Reading the Timeline
                          </h3>
                          <div className="space-y-2 text-amber-200/70 text-xs">
                            <p><strong className="text-amber-300">Chronological order:</strong> Oldest first (top to bottom)</p>
                            <p><strong className="text-amber-300">First entry:</strong> Original source article (Patient Zero)</p>
                            <p><strong className="text-amber-300">Watch for gaps:</strong> Large time gaps indicate missing links</p>
                            <p className="text-amber-400/60 italic">Timeline shows narrative evolution over time</p>
                          </div>
                        </div>
                      )}

                      {/* Badges Explained */}
                      {(!helpSearch || 'badge original source modified corrupted'.includes(helpSearch.toLowerCase())) && (
                        <div className="bg-black/30 border border-amber-900/20 p-4 rounded">
                          <h3 className="text-amber-300 font-serif font-bold mb-3 flex items-center gap-2">
                            <LucideIcon name="Award" className="w-4 h-4" />
                            Badges Explained
                          </h3>
                          <div className="space-y-2 text-amber-200/70 text-xs">
                            <p><strong className="text-emerald-300">ORIGINAL SOURCE:</strong> First article in trace (Patient Zero)</p>
                            <p><strong className="text-amber-300">MODIFIED:</strong> Article with moderate changes</p>
                            <p><strong className="text-red-300">CORRUPTED:</strong> Article heavily diverged from original</p>
                            <p className="text-amber-400/60 italic">Badges provide quick visual classification</p>
                          </div>
                        </div>
                      )}

                      {/* API Quota Info */}
                      {(!helpSearch || 'api quota gemini limit 429 exceeded'.includes(helpSearch.toLowerCase())) && (
                        <div className="bg-black/30 border border-amber-900/20 p-4 rounded">
                          <h3 className="text-amber-300 font-serif font-bold mb-3 flex items-center gap-2">
                            <LucideIcon name="Cloud" className="w-4 h-4" />
                            API Quota & Limits
                          </h3>
                          <div className="space-y-2 text-amber-200/70 text-xs">
                            <p><strong className="text-amber-300">Free tier:</strong> Limited Gemini API requests per day</p>
                            <p><strong className="text-amber-300">429 error:</strong> Quota exceeded - wait 24hrs or upgrade</p>
                            <p><strong className="text-amber-300">Monitor usage:</strong> Check ai.dev/usage for your quota</p>
                            <p className="text-amber-400/60 italic">Eco Mode bypasses quota limits</p>
                          </div>
                        </div>
                      )}
                    </div>

                    {helpSearch && <div className="mt-4 text-center text-xs text-amber-400/60 italic">Showing results for "{helpSearch}"</div>}
                  </div>
                )}
              </div>

              <div className="w-full mx-auto px-3 py-8 relative">
                {/* Search Section - styled like a classified ad box */}
                <div className="mb-8">
                  <div className="bg-gradient-to-br from-slate-800/60 to-slate-900/80 rounded-sm p-8 border-4 border-double border-amber-900/40 backdrop-blur-sm shadow-2xl relative card-hover">
                    <div className="absolute top-4 left-4 text-6xl text-amber-900/10 font-serif">"</div>
                    <div className="absolute bottom-4 right-4 text-6xl text-amber-900/10 font-serif">"</div>

                    <div className="flex items-center gap-3 mb-4">
                      <LucideIcon name="Eye" className="w-5 h-5 text-amber-700" />
                      <h2 className="text-xl font-serif text-amber-100/90">Investigation Desk</h2>
                    </div>
                    <p className="text-amber-200/60 mb-6 text-sm font-serif italic">
                      Submit a source URL to trace its narrative mutations across the information network
                    </p>

                    <div className="flex flex-col gap-3 lg:flex-row items-start">
                      <div className="flex-1 flex flex-col">
                        <span className="text-xs font-serif text-amber-200/70 uppercase tracking-widest text-amber-600 mb-1">Target Source</span>
                        <div className="relative w-full">
                          <LucideIcon name="Search" className="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-amber-700/50" />
                          <input
                            type="text"
                            value={url}
                            onChange={(e) => setUrl(e.target.value)}
                            placeholder="https://source-article.com/original-story"
                            className="w-full bg-black/60 border-2 border-amber-900/40 rounded-sm px-12 py-4 text-amber-100 placeholder-amber-700/40 focus:outline-none focus:border-amber-700/60 focus:ring-2 focus:ring-amber-700/20 font-mono text-sm transition-all duration-300 hover:bg-black/70 hover:border-amber-800/50"
                            onKeyPress={(e) => e.key === 'Enter' && startAnalysis()}
                          />
                        </div>
                      </div>

                      <div className="w-full lg:w-48 flex flex-col text-xs font-serif text-amber-200/70">
                        <span className="uppercase tracking-widest text-amber-600 mb-1">Depth Limit</span>
                        <select
                          value={maxDepth}
                          onChange={(e) => setMaxDepth(Math.min(6, Math.max(1, Number(e.target.value) || 1)))}
                          className="bg-black/60 border-2 border-amber-900/40 rounded-sm px-3 py-4 text-amber-100 focus:outline-none focus:border-amber-700/60 focus:ring-2 focus:ring-amber-700/20 font-mono text-sm transition-all duration-300 hover:bg-black/70 hover:border-amber-800/50 cursor-pointer"
                        >
                          {DEPTH_CHOICES.map((depth) => (
                            <option key={depth} value={depth}>
                              {depth} hop{depth > 1 ? 's' : ''}
                            </option>
                          ))}
                        </select>
                        <span className="text-[0.7rem] text-amber-200/50 mt-1">
                          Controls how far the crawler branches out (default 3).
                        </span>
                      </div>

                      <div className="w-full lg:w-auto flex flex-col">
                        <span className="text-xs font-serif text-amber-200/70 uppercase tracking-widest text-amber-600 mb-1 opacity-0">Action</span>
                        <button
                          onClick={startAnalysis}
                          disabled={isAnalyzing || !url}
                          className="w-full lg:w-auto px-8 py-4 bg-gradient-to-b from-amber-800 to-amber-900 rounded-sm font-serif uppercase text-sm tracking-wider hover:from-amber-700 hover:to-amber-800 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-300 flex items-center justify-center gap-2 shadow-lg border border-amber-700/50 hover:shadow-2xl hover:scale-105 active:scale-95"
                        >
                          {isAnalyzing ? (
                            <>
                              <div className="w-5 h-5 border-2 border-amber-200/30 border-t-amber-200 rounded-full animate-spin" />
                              Investigating
                            </>
                          ) : (
                            <>
                              <LucideIcon name="Zap" className="w-5 h-5" />
                              Trace Origin
                            </>
                          )}
                        </button>
                      </div>
                    </div>
                  </div>
                </div>

                {/* Results Grid */}
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                  {/* Graph Visualization - styled like newspaper columns */}
                  <div className="lg:col-span-1 bg-gradient-to-br from-slate-900/80 to-slate-800/60 rounded-sm p-6 border-2 border-amber-900/30 backdrop-blur-sm shadow-2xl">
                    <div className="border-b-2 border-amber-900/30 pb-4 mb-6">
                      <div className="flex items-center justify-between">
                        <div className="flex items-center gap-3">
                          <LucideIcon name="Link2" className="w-5 h-5 text-amber-700" />
                          <h3 className="text-xl font-serif text-amber-100/90">Citation Network</h3>
                        </div>
                        <div className="flex gap-3 text-xs font-serif">
                          <div className="flex items-center gap-1.5">
                            <div className="w-3 h-3 bg-emerald-800 border border-emerald-600 shadow-sm" />
                            <span className="text-emerald-300">Authentic</span>
                          </div>
                          <div className="flex items-center gap-1.5">
                            <div className="w-3 h-3 bg-amber-700 border border-amber-500 shadow-sm" />
                            <span className="text-amber-300">Modified</span>
                          </div>
                          <div className="flex items-center gap-1.5">
                            <div className="w-3 h-3 bg-red-900 border border-red-700 shadow-sm" />
                            <span className="text-red-300">Corrupted</span>
                          </div>
                        </div>
                      </div>
                    </div>

                    {/* Newspaper-style article cards */}
                    <div className="space-y-4">
                      {graphData.nodes.length ? (
                        [...graphData.nodes]
                          .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp))
                          .map((node, idx, sortedNodes) => {
                            const targetUrl = node.url || '#';
                            const nextNode = sortedNodes[idx + 1];
                            return (
                              <React.Fragment key={node.id}>
                                <div id={`card-${node.id}`} className="scroll-mt-24">
                                  <a
                                    href={targetUrl}
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    onClick={() => setSelectedNode(node)}
                                    className={`block p-6 border-2 border-double cursor-pointer transition-all duration-500 rounded-sm shadow-lg relative overflow-hidden ${selectedNode?.id === node.id
                                      ? 'bg-gradient-to-br from-amber-900/30 to-amber-950/25 border-amber-600/70 shadow-2xl shadow-amber-900/40 scale-[1.02] ring-2 ring-amber-500/20'
                                      : 'bg-gradient-to-br from-black/40 to-black/30 border-amber-900/40 hover:border-amber-700/60 hover:from-amber-950/30 hover:to-amber-900/20 hover:shadow-2xl hover:shadow-amber-900/20 hover:scale-[1.01]'
                                      }`}
                                  >
                                    {/* Decorative corner accent */}
                                    <div className="absolute top-0 right-0 w-16 h-16 border-t-2 border-r-2 border-amber-700/20 pointer-events-none" />
                                    <div className="flex items-start gap-5">
                                      <div className={`w-16 h-16 ${getMutationColor(node.mutationScore)} border-3 ${node.mutationScore < 0.2 ? 'border-emerald-500 shadow-emerald-900/50' :
                                        node.mutationScore < 0.5 ? 'border-amber-500 shadow-amber-900/50' :
                                          'border-red-600 shadow-red-900/50'
                                        } flex items-center justify-center flex-shrink-0 shadow-xl rounded-sm`}
                                        style={{ filter: 'drop-shadow(0 0 12px rgba(0,0,0,0.5))' }}
                                      >
                                        {node.mutationScore < 0.2 ? (
                                          <LucideIcon name="Shield" className="w-8 h-8 text-emerald-100" />
                                        ) : node.mutationScore < 0.5 ? (
                                          <LucideIcon name="TrendingUp" className="w-8 h-8 text-amber-100" />
                                        ) : (
                                          <LucideIcon name="AlertTriangle" className="w-8 h-8 text-red-100" />
                                        )}
                                      </div>
                                      <div className="flex-1 min-w-0">
                                        <div className="flex items-start justify-between mb-3">
                                          <div className="flex-1">
                                            <h4
                                              className="font-serif text-xl font-bold text-amber-50 mb-2 break-words leading-tight"
                                              style={{ ...clampStyle(2), textShadow: '1px 1px 2px rgba(0,0,0,0.5)', letterSpacing: '0.01em' }}
                                            >
                                              {node.title}
                                            </h4>
                                            <p className="text-xs text-amber-600/80 uppercase tracking-widest font-serif mb-3 font-semibold">
                                              By {node.author}
                                            </p>
                                            <p
                                              className="text-sm text-amber-200/85 font-serif leading-relaxed"
                                              style={clampStyle(3)}
                                            >
                                              {node.summary || 'Summary unavailable.'}
                                            </p>
                                          </div>
                                          <div className="flex flex-col gap-2 ml-4">
                                            <span className={`text-xs px-3 py-1.5 border-2 rounded-sm shadow-md ${node.mutationScore < 0.2 ? 'bg-emerald-900/50 border-emerald-600 text-emerald-100 shadow-emerald-900/30' :
                                              node.mutationScore < 0.5 ? 'bg-amber-900/50 border-amber-600 text-amber-100 shadow-amber-900/30' :
                                                'bg-red-900/50 border-red-600 text-red-100 shadow-red-900/30'
                                              } font-serif uppercase tracking-wider font-bold`}>
                                              {getMutationLabel(node.mutationScore)}
                                            </span>
                                            {node.depth === 0 && (
                                              <span className="text-xs px-3 py-1.5 border-2 border-emerald-500/70 text-emerald-200 uppercase tracking-wider font-serif bg-emerald-900/40 rounded-sm shadow-md shadow-emerald-900/30 font-bold">
                                                Original Source
                                              </span>
                                            )}
                                          </div>
                                        </div>
                                        <p className="text-sm text-amber-300/60 font-mono truncate border-l-3 border-amber-800/40 pl-4 mb-3 bg-black/20 py-1">{node.url}</p>
                                        <div className="flex items-center gap-4 text-xs text-amber-600/70 font-serif italic border-t-2 border-double border-amber-900/25 pt-3 mt-2">
                                          <span className="font-semibold">Mutation: {node.mutationScore.toFixed(3)}</span>
                                          <span>•</span>
                                          <span>{formatTimestamp(node.timestamp)}</span>
                                          {typeof node.originSimilarity === 'number' && (
                                            <>
                                              <span>•</span>
                                              <span>Origin Match: {formatPercent(node.originSimilarity)}</span>
                                            </>
                                          )}
                                        </div>
                                      </div>
                                      <LucideIcon name="ExternalLink" className="w-5 h-5 text-amber-600/50 transition-colors group-hover:text-amber-500/70" />
                                    </div>
                                  </a>
                                  {nextNode && (
                                    <div className="flex items-start gap-4 my-4 ml-8">
                                      <div className="flex items-center gap-3 text-amber-300 font-serif">
                                        <LucideIcon name="ArrowDownCircle" className="w-6 h-6" />
                                        <div>
                                          <div className="text-sm uppercase tracking-wide">Δ vs Original</div>
                                          <div className="font-mono text-lg">
                                            {formatPercent(nextNode.originDifference)}
                                          </div>
                                        </div>
                                      </div>
                                      <div className="flex-1 bg-black/40 border border-amber-900/40 p-4 text-sm text-amber-100/80 font-serif">
                                        <span className="block text-xs uppercase text-amber-400 tracking-wide mb-1">Gemini insight</span>
                                        <p style={{ ...clampStyle(4), wordBreak: 'break-word', overflowWrap: 'break-word' }}>
                                          {nextNode.originSummary || 'Origin comparison unavailable.'}
                                        </p>
                                      </div>
                                    </div>
                                  )}
                                </div>
                              </React.Fragment>
                            );
                          })
                      ) : (
                        <div className="text-center py-20 text-amber-400/60 font-serif italic border border-amber-900/30">
                          {isAnalyzing ? 'Collecting initial sources…' : 'Run a trace to populate the citation graph.'}
                        </div>
                      )}
                    </div>
                  </div>

                  {/* Middle Column - Investigation Data */}
                  <div className="flex flex-col gap-6 h-[calc(100vh-140px)] sticky top-6 overflow-y-auto pr-2 custom-scrollbar">
                    {/* Investigation Report */}
                    <div className="bg-gradient-to-br from-slate-900/80 to-slate-800/60 rounded-sm p-6 border-2 border-amber-900/30 backdrop-blur-sm shadow-2xl card-hover">
                      <h3 className="text-lg font-serif text-amber-100/90 mb-4 pb-2 border-b-2 border-amber-900/30 flex items-center gap-2">
                        <LucideIcon name="Activity" className="w-5 h-5 text-amber-700" />
                        Investigation Report
                      </h3>
                      <div className="space-y-4 font-serif">
                        <div className="flex justify-between items-center border-b border-amber-900/20 pb-3 transition-all hover:border-amber-800/40">
                          <span className="text-amber-300/70 text-sm">Sources Traced</span>
                          <span className="font-bold text-2xl text-amber-100 tabular-nums">{graphData.nodes.length}</span>
                        </div>
                        <div className="flex justify-between items-center border-b border-amber-900/20 pb-3 transition-all hover:border-amber-800/40">
                          <span className="text-amber-300/70 text-sm">Corruptions Found</span>
                          <span className="font-bold text-2xl text-red-300 tabular-nums">{mutationEvents.length}</span>
                        </div>
                        <div className="flex justify-between items-center border-b border-amber-900/20 pb-3 transition-all hover:border-amber-800/40">
                          <span className="text-amber-300/70 text-sm">Avg. Mutation</span>
                          <span className="font-bold text-2xl text-amber-100 tabular-nums">
                            {averageMutation.toFixed(3)}
                          </span>
                        </div>
                        <div className="flex justify-between items-center border-b border-amber-900/20 pb-3 transition-all hover:border-amber-800/40">
                          <span className="text-amber-300/70 text-sm">Origin Match</span>
                          <span className="font-bold text-2xl text-amber-100 tabular-nums">
                            {formatPercent(originMatchScore)}
                          </span>
                        </div>
                        <div className="text-xs text-amber-400/70 italic bg-black/20 p-3 rounded border border-amber-900/20">
                          {earliestNode
                            ? `Earliest source: ${earliestNode.title}`
                            : 'Earliest source not yet discovered.'}
                        </div>
                      </div>
                    </div>

                    {/* Mutation Alert Box */}
                    <div className="bg-gradient-to-br from-red-950/60 to-slate-900/80 rounded-sm p-6 border-2 border-red-900/40 backdrop-blur-sm shadow-2xl card-hover">
                      <h3 className="text-lg font-serif text-red-200 mb-4 pb-2 border-b-2 border-red-900/30 flex items-center gap-2">
                        <LucideIcon name="AlertTriangle" className="w-5 h-5 text-red-400" />
                        Corruption Alerts
                      </h3>
                      <div className="space-y-3">
                        {mutationEvents.map((event, idx) => (
                          <a
                            key={idx}
                            href={event.url || '#'}
                            target="_blank"
                            rel="noopener noreferrer"
                            onClick={(e) => {
                              e.preventDefault();
                              const targetNode = graphData?.nodes?.find((node) => node.id === event.node);
                              if (targetNode) {
                                setSelectedNode(targetNode);
                                const el = document.getElementById(`card-${targetNode.id}`);
                                if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                              }
                            }}
                            className="block p-4 bg-black/40 border-2 border-red-900/30 hover:border-red-600/50 transition-all duration-300 rounded hover:shadow-lg hover:shadow-red-900/20 hover:scale-[1.02]"
                          >
                            <div className="flex items-center justify-between mb-2 pb-2 border-b border-red-900/20">
                              <span className="text-xs font-serif text-red-300 uppercase tracking-wider flex items-center gap-2">
                                {event.type.replace('_', ' ')}
                                <LucideIcon name="ExternalLink" className="w-3.5 h-3.5" />
                              </span>
                              <span className="text-sm text-red-200 font-bold font-mono tabular-nums">
                                {event.score.toFixed(3)}
                              </span>
                            </div>
                            <p className="text-xs text-amber-200/80 font-serif mb-1" style={clampStyle(2)}>
                              {event.title}
                            </p>
                            <p className="text-xs text-amber-400/60 font-serif italic">{formatTimestamp(event.timestamp)}</p>
                          </a>
                        ))}
                        {mutationEvents.length === 0 && (
                          <p className="text-sm text-red-300/50 font-serif italic text-center py-4">
                            No major corruptions detected
                          </p>
                        )}
                      </div>
                    </div>

                    {/* Investigation Timeline */}
                    <div className="bg-gradient-to-br from-slate-900/80 to-slate-800/60 rounded-sm p-6 border-2 border-amber-900/30 backdrop-blur-sm shadow-2xl card-hover">
                      <h3 className="text-lg font-serif text-amber-100/90 mb-4 pb-2 border-b-2 border-amber-900/30 flex items-center gap-2">
                        <LucideIcon name="Footprints" className="w-5 h-5 text-amber-600" />
                        Chain of Investigation
                      </h3>
                      <div className="space-y-3 max-h-64 overflow-y-auto pr-1 custom-scrollbar">
                        {timelineEntries.length ? (
                          timelineEntries.map((entry, idx) => (
                            <div key={`${entry.id}-${idx}`} className="p-3 border border-amber-900/30 bg-black/30 text-sm font-serif text-amber-100/80 rounded transition-all duration-300 hover:bg-black/40 hover:border-amber-800/40 hover:shadow-md">
                              <div className="flex items-center justify-between mb-1 text-xs text-amber-400/80 uppercase tracking-widest">
                                <span>{formatTimestamp(entry.timestamp)}</span>
                                <span className="bg-amber-900/30 px-2 py-0.5 rounded">Step {idx + 1}</span>
                              </div>
                              <div className="font-semibold text-amber-50 mb-1 truncate">{entry.title}</div>
                              {entry.summary && (
                                <p className="text-amber-100/90 mb-1" style={clampStyle(3)}>
                                  {entry.summary}
                                </p>
                              )}
                              {entry.reason && (
                                <p className="text-amber-200/70 text-xs italic" style={clampStyle(3)}>
                                  {entry.reason}
                                </p>
                              )}
                            </div>
                          ))
                        ) : (
                          <p className="text-sm text-amber-400/60 font-serif italic">
                            Hidden investigation trail will appear once Gemini provides reasoning.
                          </p>
                        )}
                      </div>
                    </div>

                    {/* Selected Node Details */}
                    {selectedNode && (
                      <div className="bg-gradient-to-br from-slate-900/80 to-slate-800/60 rounded-sm p-6 border-2 border-amber-900/30 backdrop-blur-sm shadow-2xl card-hover">
                        <h3 className="text-lg font-serif text-amber-100/90 mb-4 pb-2 border-b-2 border-amber-900/30">
                          Article Details
                        </h3>
                        <div className="space-y-4 text-sm font-serif">
                          <div>
                            <span className="text-amber-600/80 block mb-1 uppercase text-xs tracking-wide">Headline</span>
                            <span className="font-medium text-amber-100">{selectedNode.title}</span>
                          </div>
                          <div>
                            <span className="text-amber-600/80 block mb-1 uppercase text-xs tracking-wide">Source URL</span>
                            <span className="font-mono text-xs text-amber-300/80 break-all">{selectedNode.url}</span>
                          </div>
                          <div>
                            <span className="text-amber-600/80 block mb-1 uppercase text-xs tracking-wide">Author</span>
                            <span className="text-amber-200/90">{selectedNode.author}</span>
                          </div>
                          <div>
                            <span className="text-amber-600/80 block mb-2 uppercase text-xs tracking-wide">Mutation Index</span>
                            <div className="flex items-center gap-3">
                              <div className="flex-1 h-3 bg-black/40 border border-amber-900/30 overflow-hidden">
                                <div
                                  className={`h-full ${getMutationColor(selectedNode.mutationScore)} border-r-2 ${selectedNode.mutationScore < 0.2 ? 'border-emerald-500' :
                                    selectedNode.mutationScore < 0.5 ? 'border-amber-500' :
                                      'border-red-500'
                                    }`}
                                  style={{ width: `${selectedNode.mutationScore * 100}%` }}
                                />
                              </div>
                              <span className="font-bold font-mono text-amber-100">{selectedNode.mutationScore.toFixed(3)}</span>
                            </div>
                          </div>
                          <div>
                            <span className="text-amber-600/80 block mb-2 uppercase text-xs tracking-wide">Origin Similarity</span>
                            <div className="flex items-center gap-3">
                              <div className="flex-1 h-3 bg-black/40 border border-amber-900/30 overflow-hidden">
                                <div
                                  className="h-full bg-amber-800 border-r-2 border-amber-500"
                                  style={{ width: `${(selectedNode.originSimilarity || 0) * 100}%` }}
                                />
                              </div>
                              <span className="font-bold font-mono text-amber-100">
                                {formatPercent(selectedNode.originSimilarity)}
                              </span>
                            </div>
                          </div>
                          <div>
                            <span className="text-amber-600/80 block mb-2 uppercase text-xs tracking-wide">Brief</span>
                            <p className="text-amber-100/80 leading-relaxed font-serif bg-black/20 border border-amber-900/30 p-3">
                              {selectedNode.summary || 'Summary unavailable.'}
                            </p>
                          </div>
                          <div>
                            <span className="text-amber-600/80 block mb-2 uppercase text-xs tracking-wide">Referenced URLs</span>
                            {selectedNode.references && selectedNode.references.length > 0 ? (
                              <div className="space-y-2 max-h-48 overflow-y-auto pr-1">
                                {selectedNode.references.map((href, idx) => (
                                  <a
                                    key={`${href}-${idx}`}
                                    href={href}
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    className="block text-xs font-mono text-amber-200/80 border border-amber-900/30 px-3 py-2 bg-black/30 hover:border-amber-700/60 transition-colors break-all"
                                  >
                                    {href}
                                  </a>
                                ))}
                              </div>
                            ) : (
                              <p className="text-xs text-amber-400/70 italic">No outbound links captured.</p>
                            )}
                          </div>
                        </div>
                      </div>
                    )}
                  </div>

                  {/* Right Column - Chat Interface */}
                  <div className="flex flex-col gap-6 h-[calc(100vh-140px)] sticky top-6">
                    <div className="flex-1 flex flex-col min-h-0 bg-gradient-to-br from-slate-900/80 to-slate-800/60 rounded-sm p-6 border-2 border-amber-900/30 backdrop-blur-sm shadow-2xl card-hover">
                      <div className="flex items-center justify-between mb-4 pb-2 border-b-2 border-amber-900/30">
                        <h3 className="text-lg font-serif text-amber-100/90 flex items-center gap-2">
                          <LucideIcon name="MessageSquare" className="w-5 h-5 text-amber-500" />
                          Chat with Gemini
                        </h3>
                        <select
                          value={selectedModel}
                          onChange={(e) => setSelectedModel(e.target.value)}
                          className="bg-black/40 border border-amber-900/40 text-amber-100/80 text-xs rounded-sm px-2 py-1 focus:outline-none focus:border-amber-700/60 font-mono transition-all duration-300 hover:bg-black/50 hover:border-amber-800/50 cursor-pointer"
                        >
                          {modelOptions.map((option) => (
                            <option
                              key={option.id}
                              value={option.id}
                              disabled={option.available === false}
                            >
                              {option.label}{option.available === false ? ' (Locked)' : ''}
                            </option>
                          ))}
                        </select>
                      </div>
                      <div className="chat-messages mb-4 font-serif text-sm custom-scrollbar">
                        {chatMessages.map((msg, i) => (
                          <div key={i} className={`chat-entry ${msg.role}`}>
                            <div className="avatar">
                              {msg.role === 'user' ? 'You' : msg.role === 'assistant' ? 'AI' : 'Sys'}
                            </div>
                            <div
                              className="bubble"
                              dangerouslySetInnerHTML={renderMarkdown(msg.text)}
                            />
                          </div>
                        ))}
                        <div ref={chatEndRef} />
                      </div>
                      <form onSubmit={sendChatMessage} className="flex gap-2">
                        <input
                          type="text"
                          value={chatInput}
                          onChange={(e) => setChatInput(e.target.value)}
                          placeholder="Ask about the investigation..."
                          disabled={!sessionId}
                          className="flex-1 bg-black/40 border border-amber-900/40 rounded-sm px-3 py-2 text-amber-100 text-sm focus:outline-none focus:border-amber-700/60 focus:ring-2 focus:ring-amber-700/20 transition-all duration-300 hover:bg-black/50 hover:border-amber-800/50"
                        />
                        <button
                          type="submit"
                          disabled={!sessionId || !chatInput.trim() || !selectedModel}
                          className="px-4 py-2 bg-gradient-to-b from-amber-800/80 to-amber-900/80 rounded-sm text-amber-100 hover:from-amber-700/80 hover:to-amber-800/80 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-300 shadow-md hover:shadow-lg hover:scale-105 active:scale-95"
                        >
                          <LucideIcon name="Send" className="w-4 h-4" />
                        </button>
                      </form>
                    </div>
                  </div>
                </div>

                {/* DATA VISUALIZATION - For Data Analysts */}
                {graphData.nodes.length > 0 && !isAnalyzing && (
                  <div className="mt-8 bg-gradient-to-br from-slate-900/80 to-slate-800/60 rounded-sm p-6 border-2 border-amber-900/30 backdrop-blur-sm shadow-2xl">
                    <div className="border-b-2 border-amber-900/30 pb-4 mb-6 flex items-center justify-between">
                      <div className="flex items-center gap-3">
                        <LucideIcon name="BarChart3" className="w-6 h-6 text-amber-600" />
                        <h3 className="text-2xl font-serif text-amber-100/90">Data Visualization</h3>
                      </div>
                      <div className="flex gap-2">
                        <button onClick={() => setVizMode('network')} className={`px-3 py-1.5 rounded text-xs font-serif transition ${vizMode === 'network' ? 'bg-amber-800 text-amber-100 border-2 border-amber-600' : 'bg-black/40 text-amber-300/60 border border-amber-900/30 hover:border-amber-800/50'}`}>Network</button>
                        <button onClick={() => setVizMode('chart')} className={`px-3 py-1.5 rounded text-xs font-serif transition ${vizMode === 'chart' ? 'bg-amber-800 text-amber-100 border-2 border-amber-600' : 'bg-black/40 text-amber-300/60 border border-amber-900/30 hover:border-amber-800/50'}`}>Distribution</button>
                        <button onClick={() => setVizMode('table')} className={`px-3 py-1.5 rounded text-xs font-serif transition ${vizMode === 'table' ? 'bg-amber-800 text-amber-100 border-2 border-amber-600' : 'bg-black/40 text-amber-300/60 border border-amber-900/30 hover:border-amber-800/50'}`}>Data Table</button>
                      </div>
                    </div>
                    {vizMode === 'network' && (() => {
                      const width = 1200;
                      const levels = {};
                      graphData.nodes.forEach(n => {
                        const d = n.depth || 0;
                        if (!levels[d]) levels[d] = [];
                        levels[d].push(n);
                      });

                      // Calculate dynamic height based on max nodes in any level
                      const maxNodesInLevel = Math.max(1, ...Object.values(levels).map(arr => arr.length));
                      const minSpacing = 80; // Minimum 80px between node centers
                      const height = Math.max(500, maxNodesInLevel * minSpacing + 100);

                      const layoutNodes = [];
                      const maxDepth = Math.max(0, ...Object.keys(levels).map(Number));
                      const layerWidth = width / (maxDepth + 2);

                      Object.keys(levels).forEach(d => {
                        const depth = Number(d);
                        const nodesInLevel = levels[depth];
                        const layerHeight = height / (nodesInLevel.length + 1);
                        nodesInLevel.forEach((node, idx) => {
                          layoutNodes.push({
                            ...node,
                            x: 100 + depth * layerWidth,
                            y: (idx + 1) * layerHeight
                          });
                        });
                      });

                      // Infer edges if missing (linear chain fallback)
                      let edgesToRender = graphData.edges || [];
                      if (edgesToRender.length === 0 && layoutNodes.length > 1) {
                        // Create linear edges based on sorted timestamp
                        const sorted = [...layoutNodes].sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                        for (let i = 0; i < sorted.length - 1; i++) {
                          edgesToRender.push({ source: sorted[i].id, target: sorted[i + 1].id });
                        }
                      }

                      const layoutEdges = edgesToRender.map(edge => {
                        const source = layoutNodes.find(n => n.id === edge.source);
                        const target = layoutNodes.find(n => n.id === edge.target);
                        if (!source || !target) return null;
                        return { ...edge, source, target };
                      }).filter(Boolean);

                      return (
                        <div className="bg-black/30 border border-amber-900/30 p-4 rounded overflow-hidden viz-container relative" style={{ height: 'calc(100vh - 300px)', minHeight: '800px' }}>
                          <svg width="100%" height={height} viewBox={`0 0 ${width} ${height}`}>
                            <defs>
                              <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                <polygon points="0 0, 10 3.5, 0 7" fill="#fbbf24" opacity="0.6" />
                              </marker>
                            </defs>
                            {layoutEdges.map((edge, idx) => (
                              <path
                                key={`edge-${idx}`}
                                d={`M ${edge.source.x} ${edge.source.y} C ${edge.source.x + 50} ${edge.source.y}, ${edge.target.x - 50} ${edge.target.y}, ${edge.target.x} ${edge.target.y}`}
                                fill="none"
                                stroke="#fbbf24"
                                strokeWidth="1"
                                opacity="0.4"
                                markerEnd="url(#arrowhead)"
                                className="viz-line"
                                style={{ animationDelay: `${idx * 0.01}s` }}
                              />
                            ))}
                            {layoutNodes.map((node, idx) => {
                              const score = node.mutationScore || 0;
                              const color = score < 0.2 ? '#10b981' : score < 0.5 ? '#f59e0b' : '#ef4444';
                              return (
                                <g
                                  key={node.id}
                                  className="viz-node cursor-pointer"
                                  style={{ animationDelay: `${idx * 0.1}s` }}
                                  onClick={() => {
                                    setSelectedNode(node);
                                    const el = document.getElementById(`card-${node.id}`);
                                    if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                  }}
                                  onMouseEnter={() => setHoverNode(node)}
                                  onMouseLeave={() => setHoverNode(null)}
                                >
                                  <circle cx={node.x} cy={node.y} r="25" fill={color} opacity="0.8" stroke="#fbbf24" strokeWidth="2" />
                                  <text x={node.x} y={node.y} fill="white" fontSize="12" fontWeight="bold" textAnchor="middle" dominantBaseline="middle">{idx + 1}</text>
                                  <text x={node.x} y={node.y + 40} fill="#fbbf24" fontSize="10" textAnchor="middle">{node.title?.substring(0, 12)}...</text>
                                </g>
                              );
                            })}
                          </svg>
                          {hoverNode && (() => {
                            const node = layoutNodes.find(n => n.id === hoverNode.id);
                            if (!node) return null;
                            return (
                              <div
                                className="fixed bg-slate-900/95 border-2 border-amber-500/70 p-3 rounded shadow-2xl text-xs z-50 pointer-events-none backdrop-blur-md"
                                style={{ left: node.x + 50, top: node.y + 150, width: '220px' }}
                              >
                                <div className="font-bold text-amber-100 mb-1">{node.title}</div>
                                <div className="text-amber-300/80 mb-1">{node.author}</div>
                                <div className="flex justify-between border-t border-amber-900/30 pt-1 mt-1">
                                  <span className="text-amber-500">Mutation:</span>
                                  <span className="font-mono text-amber-100">{node.mutationScore.toFixed(3)}</span>
                                </div>
                              </div>
                            );
                          })()}
                          <p className="text-xs text-amber-400/60 font-serif italic text-center mt-2">Interactive Network Graph • Hover for details • Click to jump to article</p>
                        </div>
                      );
                    })()}
                    {vizMode === 'chart' && (<div className="bg-black/30 border border-amber-900/30 p-4 rounded h-96 flex items-center justify-center viz-container"><div className="w-80 h-80"><canvas id="mutationChart"></canvas></div></div>)}
                    {vizMode === 'table' && (
                      <div className="bg-black/30 border border-amber-900/30 rounded overflow-auto viz-container" style={{ height: '600px' }}>
                        <table className="w-full text-xs" style={{ minWidth: '1200px' }}>
                          <thead className="sticky top-0 bg-slate-900 border-b-2 border-amber-900/40 z-10">
                            <tr>
                              <th className="p-3 text-left text-amber-300 font-serif whitespace-nowrap" style={{ width: '60px' }}>#</th>
                              <th className="p-3 text-left text-amber-300 font-serif" style={{ minWidth: '350px', width: '35%' }}>Title</th>
                              <th className="p-3 text-left text-amber-300 font-serif" style={{ minWidth: '150px', width: '15%' }}>Author</th>
                              <th className="p-3 text-left text-amber-300 font-serif" style={{ minWidth: '180px', width: '18%' }}>Domain</th>
                              <th className="p-3 text-left text-amber-300 font-serif whitespace-nowrap" style={{ width: '110px' }}>Mutation</th>
                              <th className="p-3 text-left text-amber-300 font-serif whitespace-nowrap" style={{ width: '120px' }}>Origin Sim</th>
                              <th className="p-3 text-left text-amber-300 font-serif whitespace-nowrap" style={{ width: '160px' }}>Timestamp</th>
                            </tr>
                          </thead>
                          <tbody>
                            {graphData.nodes.map((node, idx) => {
                              const domain = node.url ? new URL(node.url).hostname.replace('www.', '') : 'N/A';
                              return (
                                <tr
                                  key={node.id}
                                  onClick={(e) => {
                                    if (e.ctrlKey || e.metaKey) {
                                      // Ctrl/Cmd+Click: Open in new tab
                                      window.open(node.url, '_blank');
                                    } else {
                                      // Regular click: Open in new tab AND select
                                      window.open(node.url, '_blank');
                                      setSelectedNode(node);
                                    }
                                  }}
                                  className={`border-b border-amber-900/20 hover:bg-amber-950/30 table-row-animated cursor-pointer transition-colors ${selectedNode?.id === node.id ? 'bg-amber-900/30' : ''}`}
                                  style={{ animationDelay: `${idx * 0.05}s` }}
                                >
                                  <td className="p-3 text-amber-100 align-top whitespace-nowrap">{idx + 1}</td>
                                  <td className="p-3 text-amber-100 align-top">
                                    <div className="line-clamp-2" title={node.title}>{node.title}</div>
                                  </td>
                                  <td className="p-3 text-amber-200/70 align-top">
                                    <div className="truncate" title={node.author || 'Unknown'}>{node.author || 'Unknown'}</div>
                                  </td>
                                  <td className="p-3 text-amber-300/60 font-mono text-xs align-top">
                                    <div className="truncate" title={domain}>{domain}</div>
                                  </td>
                                  <td className="p-3 align-top">
                                    <span className={`px-2 py-1 rounded text-xs font-mono whitespace-nowrap inline-block ${node.mutationScore < 0.2 ? 'bg-emerald-900/40 text-emerald-200 border border-emerald-700' : node.mutationScore < 0.5 ? 'bg-amber-900/40 text-amber-200 border border-amber-700' : 'bg-red-900/40 text-red-200 border border-red-700'}`}>
                                      {node.mutationScore.toFixed(3)}
                                    </span>
                                  </td>
                                  <td className="p-3 text-amber-200/70 font-mono align-top whitespace-nowrap">
                                    {typeof node.originSimilarity === 'number' ? node.originSimilarity.toFixed(3) : 'N/A'}
                                  </td>
                                  <td className="p-3 text-amber-300/50 font-mono text-xs align-top whitespace-nowrap">
                                    {formatTimestamp(node.timestamp)}
                                  </td>
                                </tr>
                              );
                            })}
                          </tbody>
                        </table>
                      </div>
                    )}
                  </div>
                )}

                {isAnalyzing && (
                  <div className="text-center py-20">
                    <div className="w-32 h-32 bg-amber-950/20 border-4 border-double border-amber-900/40 flex items-center justify-center mx-auto mb-6">
                      <LucideIcon name="Newspaper" className="w-16 h-16 text-amber-700/40 animate-pulse" />
                    </div>
                    <h3 className="text-2xl font-serif text-amber-200/70 mb-3">
                      Investigating...
                    </h3>
                    <p className="text-amber-400/50 text-sm font-serif italic max-w-md mx-auto">
                      Tracing the narrative evolution through the shadows of the information age...
                    </p>
                  </div>
                )}

                {/* Empty State - styled like a missing persons ad */}
                {(!graphData.nodes.length) && !isAnalyzing && (
                  <div className="text-center py-20">
                    <div className="w-32 h-32 bg-amber-950/20 border-4 border-double border-amber-900/40 flex items-center justify-center mx-auto mb-6">
                      <LucideIcon name="Newspaper" className="w-16 h-16 text-amber-700/40" />
                    </div>
                    <h3 className="text-2xl font-serif text-amber-200/70 mb-3">
                      Awaiting Investigation
                    </h3>
                    <p className="text-amber-400/50 text-sm font-serif italic max-w-md mx-auto">
                      Submit a source article above to begin tracing its narrative evolution through the shadows of the information age
                    </p>
                    <div className="mt-6 flex items-center justify-center gap-2">
                      <div className="h-px w-20 bg-gradient-to-r from-transparent to-amber-800/30" />
                      <span className="text-xs text-amber-700/50 font-serif">◆</span>
                      <div className="h-px w-20 bg-gradient-to-l from-transparent to-amber-800/30" />
                    </div>
                  </div>
                )}
              </div>

              {/* Footer */}
              <div className="border-t-2 border-amber-900/30 bg-black/40 mt-12">
                <div className="max-w-7xl mx-auto px-6 py-4 text-center">
                  <p className="text-xs text-amber-700/60 font-serif italic">
                    Est. 2025 • Phylos Chronicle • Shedding Light on Digital Shadows
                  </p>
                </div>
              </div>
            </div>
          );
        }

        const root = document.getElementById('root');
        if (root) {
          ReactDOM.render(React.createElement(PhylosUI), root);
        }
      } catch (error) {
        const root = document.getElementById('root');
        if (root) {
          root.innerHTML = `<div style="padding:16px;color:#fee;background:#7a0f0f;border:2px solid #ff5b5b;font-family:monospace;">
              UI failed to load:<br>${error.message}
            </div>`;
        }
        console.error("Phylos Chronicle UI error:", error);
      }
    })();
  </script>
</body>

</html>